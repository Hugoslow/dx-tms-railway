<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX Trunking Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .status-scheduled { background: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        .status-loading { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .status-departed { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .status-in-transit { background: #eff6ff; color: #1d4ed8; border-color: #60a5fa; }
        .status-arrived { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
        .status-docked { background: #cffafe; color: #0e7490; border-color: #67e8f9; }
        .status-tipping { background: #e0e7ff; color: #3730a3; border-color: #a5b4fc; }
        .status-complete { background: #dcfce7; color: #166534; border-color: #86efac; }
        .status-delayed { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
        .status-cancelled { background: #fef2f2; color: #991b1b; border-color: #fecaca; text-decoration: line-through; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container { max-height: calc(100vh - 280px); overflow-y: auto; }
        thead th { position: sticky; top: 0; z-index: 10; }
        .stat-card { transition: all 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: #0066B3; }
        .hub-card { transition: all 0.2s; cursor: pointer; }
        .hub-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: #0066B3; }
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { background: #0066B3; color: white; }
        .tab-btn:not(.active):hover { background: #e0f0ff; }
        .dx-header { background: linear-gradient(135deg, #00A0E3 0%, #004B87 100%); }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .filter-btn { transition: all 0.2s; }
        .filter-btn.active { background: #0066B3; color: white; }
        .direction-inbound { background: #dbeafe; color: #1e40af; }
        .direction-outbound { background: #ffedd5; color: #c2410c; }
        .direction-transfer { background: #f3e8ff; color: #7c3aed; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #e2e8f0 !important; }
        .refresh-indicator { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .password-strength { height: 4px; transition: all 0.3s; }
        .strength-weak { background: #ef4444; width: 25%; }
        .strength-fair { background: #f97316; width: 50%; }
        .strength-good { background: #eab308; width: 75%; }
        .strength-strong { background: #22c55e; width: 100%; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="dx-header px-6 py-8 text-center">
                <div class="w-24 h-24 bg-white rounded-lg mx-auto mb-4 flex items-center justify-center p-2">
                    <img src="/dx-logo.png" alt="DX" class="w-full h-full object-contain">
                </div>
                <h1 class="text-2xl font-bold text-white">Trunking Management System</h1>
                <p class="text-blue-200 mt-1">Real-Time Trunking Operations</p>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Username</label><input type="text" id="loginUsername" placeholder="Enter username" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onkeypress="if(event.key==='Enter')login()"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" id="loginPassword" placeholder="Enter password" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onkeypress="if(event.key==='Enter')login()"></div>
                <button onclick="login()" id="loginBtn" class="w-full py-3 bg-[#0066B3] text-white font-semibold rounded-lg hover:bg-[#004B87] disabled:opacity-50 disabled:cursor-not-allowed">Sign In</button>
                <p id="loginError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
            <div class="px-6 pb-6">
                <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-500">
                    <p class="flex items-center gap-2"><i data-lucide="shield" class="w-4 h-4"></i>Secure login with session management</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Force Password Change Modal -->
    <div id="forcePasswordModal" class="fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-amber-500 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="alert-triangle" class="w-6 h-6"></i>Password Change Required</h2>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-slate-600">You must change your password before continuing. Please choose a strong password.</p>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Current Password</label><input type="password" id="forceCurrentPassword" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">New Password</label><input type="password" id="forceNewPassword" oninput="checkPasswordStrength('forceNewPassword', 'forceStrengthBar', 'forceStrengthText')" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                    <div class="mt-2 bg-slate-200 rounded-full overflow-hidden"><div id="forceStrengthBar" class="password-strength"></div></div>
                    <p id="forceStrengthText" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label><input type="password" id="forceConfirmPassword" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500"></div>
                <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-600">
                    <p class="font-medium mb-1">Password requirements:</p>
                    <ul class="space-y-1">
                        <li id="forceReq1" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>At least 8 characters</li>
                        <li id="forceReq2" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One uppercase letter</li>
                        <li id="forceReq3" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One lowercase letter</li>
                        <li id="forceReq4" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One number</li>
                    </ul>
                </div>
                <button onclick="forceChangePassword()" class="w-full py-3 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">Change Password & Continue</button>
                <p id="forcePasswordError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="key" class="w-5 h-5"></i>Change Password</h2>
                <button onclick="closeChangePasswordModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Current Password</label><input type="password" id="currentPassword" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-cyan-500"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">New Password</label><input type="password" id="newPassword" oninput="checkPasswordStrength('newPassword', 'strengthBar', 'strengthText')" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-cyan-500">
                    <div class="mt-2 bg-slate-200 rounded-full overflow-hidden"><div id="strengthBar" class="password-strength"></div></div>
                    <p id="strengthText" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label><input type="password" id="confirmPassword" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-cyan-500"></div>
                <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-600">
                    <p class="font-medium mb-1">Password requirements:</p>
                    <ul class="space-y-1">
                        <li id="req1" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>At least 8 characters</li>
                        <li id="req2" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One uppercase letter</li>
                        <li id="req3" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One lowercase letter</li>
                        <li id="req4" class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One number</li>
                    </ul>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="changePassword()" class="flex-1 py-3 bg-[#0099cc] text-white font-semibold rounded-lg hover:bg-[#007399]">Change Password</button>
                </div>
                <p id="changePasswordError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Session Timeout Warning Modal -->
    <div id="sessionWarningModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-amber-500 px-6 py-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i>Session Expiring</h2>
            </div>
            <div class="p-6 text-center">
                <p class="text-slate-600 mb-4">Your session will expire in <span id="sessionCountdown" class="font-bold text-amber-600">60</span> seconds due to inactivity.</p>
                <button onclick="extendSession()" class="w-full py-3 bg-[#0099cc] text-white font-semibold rounded-lg hover:bg-[#007399]">Stay Logged In</button>
            </div>
        </div>
    </div>

    <!-- Admin Reset Password Modal -->
    <div id="resetPasswordModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-red-500 px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="key" class="w-5 h-5"></i>Reset User Password</h2>
                <button onclick="closeResetPasswordModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-slate-600">Reset password for: <strong id="resetUserName"></strong></p>
                <input type="hidden" id="resetUserId">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">New Password</label><input type="password" id="resetNewPassword" oninput="checkPasswordStrength('resetNewPassword', 'resetStrengthBar', 'resetStrengthText')" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                    <div class="mt-2 bg-slate-200 rounded-full overflow-hidden"><div id="resetStrengthBar" class="password-strength"></div></div>
                    <p id="resetStrengthText" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                    <p class="flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i>User will be required to change password on next login.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeResetPasswordModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="adminResetPassword()" class="flex-1 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Reset Password</button>
                </div>
                <p id="resetPasswordError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-emerald-500 px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5"></i>Add New User</h2>
                <button onclick="closeAddUserModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Username</label><input type="text" id="newUsername" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="e.g. jsmith"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label><input type="text" id="newFullName" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="e.g. John Smith"></div>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="newEmail" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="john.smith@dxdelivery.com"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Role</label>
                        <select id="newRole" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="viewer">Viewer</option>
                            <option value="depot">Depot Staff</option>
                            <option value="gatehouse">Gatehouse</option>
                            <option value="hub-ops">Hub Operations</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="planner">Planner</option>
                            <option value="finance">Finance</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Location</label><input type="text" id="newLocation" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="e.g. Nuneaton"></div>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" id="newUserPassword" oninput="checkPasswordStrength('newUserPassword', 'newUserStrengthBar', 'newUserStrengthText')" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                    <div class="mt-2 bg-slate-200 rounded-full overflow-hidden"><div id="newUserStrengthBar" class="password-strength"></div></div>
                    <p id="newUserStrengthText" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-600">
                    <p class="font-medium mb-1">Password requirements:</p>
                    <ul class="space-y-1">
                        <li class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>At least 8 characters</li>
                        <li class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One uppercase letter</li>
                        <li class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One lowercase letter</li>
                        <li class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3"></i>One number</li>
                    </ul>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                    <p class="flex items-center gap-2"><i data-lucide="info" class="w-4 h-4"></i>User will be required to change password on first login.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeAddUserModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="createUser()" class="flex-1 py-3 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600">Create User</button>
                </div>
                <p id="addUserError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Add Trunk Modal -->
    <div id="addTrunkModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i>Add Trunk Movement</h2>
                <button onclick="closeAddTrunkModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Trunk ID</label><input type="text" id="newTrunkId" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase" placeholder="e.g. TRK0500"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Route Ref</label><input type="text" id="newRouteRef" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase" placeholder="e.g. NUN 01"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Origin</label>
                        <select id="newOrigin" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="">-- Select --</option>
                            <option value="NUNEATON HUB 1">Nuneaton Hub 1</option>
                            <option value="HUB 2 NUNEATON">Hub 2 Nuneaton</option>
                            <option value="BRACKNELL HUB">Bracknell Hub</option>
                            <option value="BRISTOL HUB">Bristol Hub</option>
                            <option value="HAYDOCK HUB">Haydock Hub</option>
                            <option value="LEEDS HUB">Leeds Hub</option>
                            <option value="HOLLIES">Hollies</option>
                            <option value="OTHER">Other (specify)</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Destination</label>
                        <select id="newDestination" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="">-- Select --</option>
                            <option value="NUNEATON HUB 1">Nuneaton Hub 1</option>
                            <option value="HUB 2 NUNEATON">Hub 2 Nuneaton</option>
                            <option value="BRACKNELL HUB">Bracknell Hub</option>
                            <option value="BRISTOL HUB">Bristol Hub</option>
                            <option value="HAYDOCK HUB">Haydock Hub</option>
                            <option value="LEEDS HUB">Leeds Hub</option>
                            <option value="HOLLIES">Hollies</option>
                            <option value="OTHER">Other (specify)</option>
                        </select>
                    </div>
                </div>
                <div id="customOriginContainer" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Custom Origin</label>
                    <input type="text" id="customOrigin" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Enter origin name">
                </div>
                <div id="customDestinationContainer" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Custom Destination</label>
                    <input type="text" id="customDestination" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Enter destination name">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Direction</label>
                        <select id="newDirection" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="INBOUND">Inbound</option>
                            <option value="OUTBOUND">Outbound</option>
                            <option value="TRANSFER">Transfer</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Sched Dep</label><input type="time" id="newSchedDep" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">ETA</label><input type="time" id="newSchedArr" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contractor</label><input type="text" id="newContractor" class="w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="e.g. FTS"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Vehicle Type</label>
                        <select id="newVehicleType" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="ARTIC">Artic</option>
                            <option value="RIGID">Rigid</option>
                            <option value="VAN">Van</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeAddTrunkModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="createTrunk()" class="flex-1 py-3 bg-[#0066B3] text-white font-semibold rounded-lg hover:bg-[#004B87]">Add Trunk</button>
                </div>
                <p id="addTrunkError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Edit Trunk Modal -->
    <div id="editTrunkModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-amber-500 px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="edit" class="w-5 h-5"></i>Edit Trunk (Today Only)</h2>
                <button onclick="closeEditTrunkModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editTrunkMovementId">
                <div class="bg-slate-50 rounded-lg p-3 mb-4">
                    <p class="text-sm"><strong>Trunk:</strong> <span id="editTrunkDisplay"></span></p>
                    <p class="text-sm"><strong>Route:</strong> <span id="editRouteDisplay"></span></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contractor</label><input type="text" id="editContractor" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Vehicle Type</label>
                        <select id="editVehicleType" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            <option value="ARTIC">Artic</option>
                            <option value="RIGID">Rigid</option>
                            <option value="VAN">Van</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Vehicle Reg</label><input type="text" id="editVehicleReg" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Trailer</label><input type="text" id="editTrailer" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Driver Name</label><input type="text" id="editDriverName" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Driver Mobile</label><input type="text" id="editDriverMobile" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Scheduled Dep</label><input type="time" id="editSchedDep" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Scheduled Arr</label><input type="time" id="editSchedArr" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                    <p class="flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i>Changes only affect today's movement, not the master schedule.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEditTrunkModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="saveEditTrunk()" class="flex-1 py-3 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">Save Changes</button>
                </div>
                <p id="editTrunkError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Daily Report Detail Modal -->
    <div id="dailyReportModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="bg-[#0099cc] px-6 py-4 flex items-center justify-between sticky top-0">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="calendar-check" class="w-5 h-5"></i>Daily Report - <span id="reportDetailDate"></span></h2>
                <div class="flex items-center gap-2">
                    <button onclick="exportDailyReport()" class="flex items-center gap-2 px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-medium"><i data-lucide="download" class="w-4 h-4"></i>Export</button>
                    <button onclick="closeDailyReportModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="p-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-50 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-slate-800" id="reportDetailTotal">0</p>
                        <p class="text-xs text-slate-500">Total Movements</p>
                    </div>
                    <div class="bg-emerald-50 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-emerald-600" id="reportDetailCompletion">0%</p>
                        <p class="text-xs text-slate-500">Completion Rate</p>
                    </div>
                    <div class="rounded-lg p-3 text-center" id="reportDetailDepOtpCard">
                        <p class="text-2xl font-bold" id="reportDetailDepOtp">0%</p>
                        <p class="text-xs text-slate-500">Dep OTP</p>
                    </div>
                    <div class="rounded-lg p-3 text-center" id="reportDetailArrOtpCard">
                        <p class="text-2xl font-bold" id="reportDetailArrOtp">0%</p>
                        <p class="text-xs text-slate-500">Arr OTP</p>
                    </div>
                </div>
                
                <!-- Hub Breakdown -->
                <div class="mb-6">
                    <h4 class="font-semibold text-slate-700 mb-2">Hub Breakdown</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="bg-slate-100"><th class="px-3 py-2 text-left">Hub</th><th class="px-3 py-2 text-center">Total</th><th class="px-3 py-2 text-center">Completed</th><th class="px-3 py-2 text-center">In Progress</th><th class="px-3 py-2 text-center">Delayed</th></tr></thead>
                            <tbody id="reportDetailHubBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Contractor Breakdown -->
                <div class="mb-6">
                    <h4 class="font-semibold text-slate-700 mb-2">Contractor Breakdown</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="bg-slate-100"><th class="px-3 py-2 text-left">Contractor</th><th class="px-3 py-2 text-center">Total</th><th class="px-3 py-2 text-center">Completed</th><th class="px-3 py-2 text-center">Delayed</th></tr></thead>
                            <tbody id="reportDetailContractorBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Delayed Movements -->
                <div id="reportDetailDelayedSection" class="hidden">
                    <h4 class="font-semibold text-slate-700 mb-2 text-red-600">Delayed Movements</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="bg-red-50"><th class="px-3 py-2 text-left">Trunk</th><th class="px-3 py-2 text-left">Route</th><th class="px-3 py-2 text-left">Contractor</th><th class="px-3 py-2 text-left">Route</th></tr></thead>
                            <tbody id="reportDetailDelayedBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Date Modal -->
    <div id="copyDateModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-amber-500 px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="copy" class="w-5 h-5"></i>Copy Historical Date</h2>
                <button onclick="closeCopyDateModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-slate-600 text-sm">Copy all movements from a past date to a future date. This will include all amendments made on that day.</p>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Source Date (Historical)</label>
                    <input type="date" id="copySourceDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                    <p class="text-xs text-slate-500 mt-1">Select a past date to copy from</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Target Date (Future)</label>
                    <input type="date" id="copyTargetDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                    <p class="text-xs text-slate-500 mt-1">Select a future date to copy to</p>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                    <p class="flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i>This will overwrite any existing movements for the target date.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeCopyDateModal()" class="flex-1 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                    <button onclick="executeCopyDate()" class="flex-1 py-3 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">Copy Date</button>
                </div>
                <p id="copyDateError" class="text-red-600 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Route Legs Modal -->
    <div id="routeLegsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden">
            <div class="bg-indigo-500 px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="route" class="w-5 h-5"></i>Route Legs: <span id="routeLegsTitle"></span></h2>
                <button onclick="closeRouteLegsModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <p class="text-slate-600 text-sm mb-4">All legs of this route displayed in departure order. This shows the journey progression.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Leg</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Trunk ID</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Origin</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Destination</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Sched Dep</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actual Dep</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">ETA</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Arrival</th>
                            </tr>
                        </thead>
                        <tbody id="routeLegsBody"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="closeRouteLegsModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <header class="dx-header text-white shadow-lg sticky top-0 z-40">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded flex items-center justify-center p-1">
                            <img src="/DX_logo.png" alt="DX" class="w-full h-full object-contain">
                        </div>
                        <div><h1 class="text-lg font-bold tracking-tight">Trunking Management System</h1><p class="text-xs text-blue-200">Real-Time Operations</p></div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="hidden md:flex items-center gap-2 text-sm">
                            <i data-lucide="clock" class="w-4 h-4 text-blue-200"></i><span id="currentTime" class="font-mono"></span>
                            <span class="text-blue-300">|</span><span id="currentDate"></span>
                            <span class="text-blue-300">|</span>
                            <button onclick="refreshData()" id="refreshBtn" class="flex items-center gap-1 hover:text-blue-200" title="Refresh data"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                            <span id="lastUpdate" class="text-xs text-blue-300"></span>
                        </div>
                        <div class="flex items-center gap-3 pl-4 border-l border-white/20">
                            <div class="text-right hidden sm:block"><p id="displayUsername" class="text-sm font-medium"></p><p id="displayRole" class="text-xs text-blue-200"></p></div>
                            <div class="relative">
                                <button onclick="toggleUserMenu()" class="flex items-center gap-1 px-3 py-1.5 hover:bg-white/10 rounded-lg text-sm"><i data-lucide="user" class="w-4 h-4"></i><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                                <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50">
                                    <button onclick="openChangePasswordModal()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2"><i data-lucide="key" class="w-4 h-4"></i>Change Password</button>
                                    <hr class="my-1">
                                    <button onclick="logout()" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i>Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-4 py-2 bg-black/20 flex items-center gap-6 overflow-x-auto">
                <div id="dateSelectorContainer" class="flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="calendar" class="w-4 h-4 text-blue-200"></i>
                    <span id="currentDateLabel" class="font-semibold text-white">Today</span>
                    <input type="date" id="dateSelector" onchange="changeDate()" class="bg-white/10 border border-white/20 rounded px-2 py-1 text-white text-sm" title="Select date">
                    <button onclick="goToToday()" id="goToTodayBtn" class="hidden px-2 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-medium" title="Go to today">‚Üê Today</button>
                    <button id="copyDateBtn" onclick="openCopyDateModal()" class="hidden px-2 py-1 bg-amber-500/80 hover:bg-amber-500 rounded text-xs" title="Copy from historical date"><i data-lucide="copy" class="w-3 h-3 inline"></i> Copy</button>
                </div>
                <span class="text-blue-300">|</span>
                <div class="flex items-center gap-2 text-sm whitespace-nowrap"><span class="text-blue-200">Total:</span><span id="statTotal" class="font-semibold">0</span></div>
                <div class="flex items-center gap-2 text-sm whitespace-nowrap"><span class="text-blue-200">Inbound:</span><span id="statInbound" class="font-semibold text-blue-300">0</span></div>
                <div class="flex items-center gap-2 text-sm whitespace-nowrap"><span class="text-blue-200">Outbound:</span><span id="statOutbound" class="font-semibold text-orange-300">0</span></div>
                <div class="flex items-center gap-2 text-sm whitespace-nowrap"><span class="text-blue-200">Transfer:</span><span id="statTransfer" class="font-semibold text-purple-300">0</span></div>
                <div class="flex items-center gap-2 text-sm whitespace-nowrap"><i data-lucide="truck" class="w-4 h-4 text-blue-300"></i><span class="text-blue-200">In Transit:</span><span id="statInTransit" class="font-semibold text-blue-300">0</span></div>
                <div id="addTrunkBtnContainer" class="hidden ml-auto"><button onclick="openAddTrunkModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Add Trunk</button></div>
            </div>
        </header>

        <div class="bg-white border-b border-slate-200 px-4">
            <div class="flex items-center gap-1 overflow-x-auto py-2">
                <button onclick="showView('dashboard')" class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-dashboard" data-view="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4"></i>Dashboard</button>
                <button onclick="showView('live-board')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-live-board" data-view="live-board"><i data-lucide="monitor" class="w-4 h-4"></i>Live Board</button>
                <button onclick="showView('schedule')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-schedule" data-view="schedule"><i data-lucide="calendar" class="w-4 h-4"></i>Schedule</button>
                <button onclick="showView('depot-departure')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-depot-departure" data-view="depot-departure"><i data-lucide="log-out" class="w-4 h-4"></i>Depot Departure</button>
                <button onclick="showView('hub-arrival')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-hub-arrival" data-view="hub-arrival"><i data-lucide="log-in" class="w-4 h-4"></i>Hub Arrival</button>
                <button onclick="showView('hub-operations')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-hub-operations" data-view="hub-operations"><i data-lucide="warehouse" class="w-4 h-4"></i>Hub Operations</button>
                <button onclick="showView('audit-log')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-audit-log" data-view="audit-log"><i data-lucide="file-text" class="w-4 h-4"></i>Audit Log</button>
                <button onclick="showView('metrics')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-metrics" data-view="metrics"><i data-lucide="bar-chart-3" class="w-4 h-4"></i>Metrics</button>
                <button onclick="showView('costing')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-costing" data-view="costing"><i data-lucide="pound-sterling" class="w-4 h-4"></i>Costing</button>
                <button onclick="showView('users')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 tab-users" data-view="users"><i data-lucide="users" class="w-4 h-4"></i>Users</button>
            </div>
        </div>

        <main class="p-4">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-panel">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('scheduled')"><i data-lucide="calendar" class="w-5 h-5 text-slate-400 mb-2"></i><p class="text-2xl font-bold text-slate-800" id="dashStatScheduled">0</p><p class="text-xs text-slate-500">Scheduled</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('loading')"><i data-lucide="package" class="w-5 h-5 text-amber-500 mb-2"></i><p class="text-2xl font-bold text-amber-600" id="dashStatLoading">0</p><p class="text-xs text-slate-500">Loading</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('departed')"><i data-lucide="log-out" class="w-5 h-5 text-blue-500 mb-2"></i><p class="text-2xl font-bold text-blue-600" id="dashStatDeparted">0</p><p class="text-xs text-slate-500">Departed</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('in-transit')"><i data-lucide="truck" class="w-5 h-5 text-indigo-500 mb-2"></i><p class="text-2xl font-bold text-indigo-600" id="dashStatInTransit">0</p><p class="text-xs text-slate-500">In Transit</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('arrived')"><i data-lucide="log-in" class="w-5 h-5 text-teal-500 mb-2"></i><p class="text-2xl font-bold text-teal-600" id="dashStatArrived">0</p><p class="text-xs text-slate-500">Arrived</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('complete')"><i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-500 mb-2"></i><p class="text-2xl font-bold text-emerald-600" id="dashStatComplete">0</p><p class="text-xs text-slate-500">Complete</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-red-200 shadow-sm bg-red-50" onclick="filterByStatus('delayed')"><i data-lucide="alert-triangle" class="w-5 h-5 text-red-500 mb-2"></i><p class="text-2xl font-bold text-red-600" id="dashStatDelayed">0</p><p class="text-xs text-red-600">Delayed</p></div>
                    <div class="stat-card bg-white rounded-xl p-4 border border-slate-200 shadow-sm" onclick="filterByStatus('cancelled')"><i data-lucide="x-circle" class="w-5 h-5 text-slate-400 mb-2"></i><p class="text-2xl font-bold text-slate-500" id="dashStatCancelled">0</p><p class="text-xs text-slate-500">Cancelled</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="hubCards"></div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200"><h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="activity" class="w-5 h-5 text-slate-600"></i>Recent Activity</h3></div><div class="p-4 max-h-64 overflow-y-auto" id="recentActivity"></div></div>
            </div>

            <!-- Live Board View -->
            <div id="view-live-board" class="view-panel hidden">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200 flex flex-wrap items-center justify-between gap-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="monitor" class="w-5 h-5"></i>Live Trunk Board <span class="text-slate-400 font-normal text-sm" id="liveBoardCount"></span></h3>
                        <div class="flex flex-wrap items-center gap-3">
                            <input type="text" id="liveBoardSearch" placeholder="Search..." oninput="renderLiveBoard()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm w-32">
                            <select id="liveBoardRouteFilter" onchange="filterByRoute()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Routes</option></select>
                            <select id="liveBoardHubFilter" onchange="renderLiveBoard()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Hubs</option></select>
                            <select id="liveBoardStatusFilter" onchange="renderLiveBoard()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Statuses</option></select>
                            <select id="liveBoardDirectionFilter" onchange="renderLiveBoard()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Directions</option><option value="INBOUND">Inbound</option><option value="OUTBOUND">Outbound</option><option value="TRANSFER">Transfer</option></select>
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="hideCancelled" onchange="renderLiveBoard()" checked class="rounded">Hide Cancelled</label>
                        </div>
                    </div>
                    <div class="table-container overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('trunk_id')">Trunk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('route_ref')">Route Ref</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('status')">Status</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('direction')">Direction</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('contractor')">Contractor</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('origin')">Origin</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('destination')">Destination</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('scheduled_dep')">Sched Dep</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 sortable" onclick="sortBy('scheduled_arr')">ETA</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 col-actions">Actions</th>
                    </tr></thead><tbody id="liveBoardBody"></tbody></table></div>
                </div>
            </div>

            <!-- Schedule View -->
            <div id="view-schedule" class="view-panel hidden">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200"><h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5"></i>Today's Schedule <span class="text-slate-400 font-normal text-sm" id="scheduleCount"></span></h3></div>
                    <div class="table-container overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Trunk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Route Ref</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Status</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Direction</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Origin</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Destination</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Contractor</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Sched Dep</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">ETA</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50 col-edit">Edit</th>
                    </tr></thead><tbody id="scheduleBody"></tbody></table></div>
                </div>
            </div>

            <!-- Depot Departure View -->
            <div id="view-depot-departure" class="view-panel hidden">
                <div id="depotContent" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 bg-[#e0f4fc]"><h3 class="font-semibold text-[#007399] flex items-center gap-2"><i data-lucide="log-out" class="w-5 h-5"></i>Log Departure</h3></div><div class="p-4 space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Departing From</label><select id="depotOriginFilter" onchange="renderDepotDeparture()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-amber-50"><option value="">-- Select Depot --</option></select></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Trunk</label><select id="depTrunkSelect" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">-- Select Depot First --</option></select></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 mb-1">Vehicle</label><input type="text" id="depVehicleReg" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Trailer</label><input type="text" id="depTrailer" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 mb-1">Driver</label><input type="text" id="depDriverName" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Fill %</label><input type="number" id="depFill" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 mb-1">Seal</label><input type="text" id="depSeal" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Time</label><input type="time" id="depTime" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div></div>
                        <button onclick="logDeparture()" class="w-full py-3 bg-[#0099cc] text-white font-semibold rounded-lg hover:bg-[#007399]">Log Departure</button>
                    </div></div></div>
                    <div class="lg:col-span-2"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between"><h3 class="font-semibold text-slate-800">Pending Departures <span class="text-slate-400 font-normal text-sm" id="pendingDepCount"></span></h3><span id="depotFilterLabel" class="text-sm text-amber-600 font-medium"></span></div><div class="table-container"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Trunk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Route Ref</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Contractor</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Route</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Sched Dep</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Status</th>
                    </tr></thead><tbody id="pendingDeparturesBody"></tbody></table></div></div></div>
                </div>
            </div>

            <!-- Hub Arrival View -->
            <div id="view-hub-arrival" class="view-panel hidden">
                <div id="arrivalContent" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 bg-teal-50"><h3 class="font-semibold text-teal-800 flex items-center gap-2"><i data-lucide="log-in" class="w-5 h-5"></i>Log Arrival</h3></div><div class="p-4 space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Trunk</label><select id="arrTrunkSelect" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">-- Select --</option></select></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Gate Time</label><input type="time" id="arrGateTime" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Seal</label><input type="text" id="arrSealVerify" class="w-full px-3 py-2 border border-slate-200 rounded-lg uppercase"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Bay</label><select id="arrBay" class="w-full px-3 py-2 border border-slate-200 rounded-lg"><option value="">-- Select --</option><option>Bay 1</option><option>Bay 2</option><option>Bay 3</option><option>Bay 4</option><option>Bay 5</option><option>Bay 6</option><option>YARD</option></select></div>
                        <button onclick="logArrival()" class="w-full py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700">Log Arrival</button>
                    </div></div></div>
                    <div class="lg:col-span-2"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between"><h3 class="font-semibold text-slate-800">Expected Arrivals <span class="text-slate-400 font-normal text-sm" id="expectedArrCount"></span></h3><select id="arrivalHubFilter" onchange="renderHubArrival()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Hubs</option></select></div><div class="table-container"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Trunk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Route Ref</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Origin</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">To</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Departed</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">ETA</th>
                    </tr></thead><tbody id="expectedArrivalsBody"></tbody></table></div></div></div>
                </div>
            </div>

            <!-- Hub Operations View -->
            <div id="view-hub-operations" class="view-panel hidden">
                <div id="hubopsContent" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 bg-purple-50"><h3 class="font-semibold text-purple-800 flex items-center gap-2"><i data-lucide="warehouse" class="w-5 h-5"></i>Update Operations</h3></div><div class="p-4 space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Trunk</label><select id="opsTrunkSelect" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">-- Select --</option></select></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Dock Time</label><input type="time" id="opsDockTime" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Tip Start</label><input type="time" id="opsTipStart" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Tip Complete</label><input type="time" id="opsTipComplete" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
                        <button onclick="updateOperations()" class="w-full py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700">Update</button>
                    </div></div></div>
                    <div class="lg:col-span-2"><div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between"><h3 class="font-semibold text-slate-800">Docked Trailers</h3><select id="opsHubFilter" onchange="renderHubOperations()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm"><option value="">All Hubs</option></select></div><div class="table-container"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Trunk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Route Ref</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Bay</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Hub</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Origin</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Arrived</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Status</th>
                    </tr></thead><tbody id="dockedTrailersBody"></tbody></table></div></div></div>
                </div>
            </div>

            <!-- Audit Log View -->
            <div id="view-audit-log" class="view-panel hidden">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm"><div class="px-4 py-3 border-b border-slate-200"><h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5"></i>Audit Log</h3></div><div class="table-container"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200"><th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Time</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">User</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Action</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Details</th></tr></thead><tbody id="auditLogBody"></tbody></table></div></div>
            </div>

            <!-- Metrics View -->
            <div id="view-metrics" class="view-panel hidden">
                <!-- Network Summary -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-5 h-5"></i>Network Performance - Today</h3>
                        <button id="networkRefreshBtn" onclick="refreshMetrics()" class="flex items-center gap-2 px-3 py-1.5 bg-[#0099cc] hover:bg-[#007399] text-white rounded-lg text-sm font-medium"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Refresh</button>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <div class="bg-slate-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-slate-800" id="metricTotal">0</p>
                                <p class="text-xs text-slate-500">Total Trunks</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-blue-600" id="metricDeparted">0</p>
                                <p class="text-xs text-slate-500">Departed</p>
                            </div>
                            <div class="bg-teal-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-teal-600" id="metricArrived">0</p>
                                <p class="text-xs text-slate-500">Arrived</p>
                            </div>
                            <div class="bg-emerald-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-emerald-600" id="metricComplete">0</p>
                                <p class="text-xs text-slate-500">Complete</p>
                            </div>
                            <div class="rounded-lg p-4 text-center" id="metricDepOnTimeCard">
                                <p class="text-3xl font-bold" id="metricDepOnTime">0%</p>
                                <p class="text-xs text-slate-500">Dep On-Time</p>
                            </div>
                            <div class="rounded-lg p-4 text-center" id="metricArrOnTimeCard">
                                <p class="text-3xl font-bold" id="metricArrOnTime">0%</p>
                                <p class="text-xs text-slate-500">Arr On-Time</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
                            <div class="bg-orange-50 rounded-lg p-4 text-center border-2 border-orange-200">
                                <p class="text-3xl font-bold text-orange-600" id="metricToGo">0</p>
                                <p class="text-xs text-slate-500">Trunks To Go</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="metricDepMinsLost">0</p>
                                <p class="text-xs text-slate-500">Dep Mins Lost</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="metricArrMinsLost">0</p>
                                <p class="text-xs text-slate-500">Arr Mins Lost</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-purple-600" id="metricAvgTurnaround">0</p>
                                <p class="text-xs text-slate-500">Avg Turnaround (mins)</p>
                            </div>
                            <div class="bg-indigo-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-indigo-600" id="metricAvgTip">0</p>
                                <p class="text-xs text-slate-500">Avg Tip Duration (mins)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hub Performance Table -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="warehouse" class="w-5 h-5"></i>Hub Performance - Today</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Hub</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Total</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Departed</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Arrived</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Complete</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Dep On-Time</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Arr On-Time</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Mins Lost (Dep)</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Mins Lost (Arr)</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Avg Turnaround</th>
                                </tr>
                            </thead>
                            <tbody id="hubMetricsBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Daily Reports (5am Snapshots) -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="calendar-check" class="w-5 h-5"></i>Daily Reports (5am Snapshots)</h3>
                        <div class="flex items-center gap-2">
                            <select id="dailyReportDays" onchange="loadDailyReports()" class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm">
                                <option value="7">Last 7 Days</option>
                                <option value="14">Last 14 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                            <button onclick="loadDailyReports()" class="flex items-center gap-2 px-3 py-1.5 bg-[#0099cc] hover:bg-[#007399] text-white rounded-lg text-sm font-medium"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Date</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Total</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Completed</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Completion %</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Dep OTP</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Arr OTP</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Delayed</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Cancelled</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dailyReportsBody">
                                <tr><td colspan="9" class="text-center py-8 text-slate-500">Loading reports...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Day Comparison Tool -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="git-compare" class="w-5 h-5"></i>Compare Days</h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Day 1</label>
                                <input type="date" id="compareDate1" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Day 2</label>
                                <input type="date" id="compareDate2" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            </div>
                            <div class="flex items-end">
                                <button onclick="compareDays()" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="git-compare" class="w-4 h-4"></i>Compare
                                </button>
                            </div>
                        </div>
                        <div id="comparisonResult" class="hidden">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-slate-50 rounded-lg p-4 text-center">
                                    <p class="text-xs text-slate-500 mb-1">Completion Rate</p>
                                    <p class="text-lg font-bold" id="compareCompletion">-</p>
                                    <p class="text-xs" id="compareCompletionChange">-</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-4 text-center">
                                    <p class="text-xs text-slate-500 mb-1">Departure OTP</p>
                                    <p class="text-lg font-bold" id="compareDepOtp">-</p>
                                    <p class="text-xs" id="compareDepOtpChange">-</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-4 text-center">
                                    <p class="text-xs text-slate-500 mb-1">Arrival OTP</p>
                                    <p class="text-lg font-bold" id="compareArrOtp">-</p>
                                    <p class="text-xs" id="compareArrOtpChange">-</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-4 text-center">
                                    <p class="text-xs text-slate-500 mb-1">Delayed</p>
                                    <p class="text-lg font-bold" id="compareDelayed">-</p>
                                    <p class="text-xs" id="compareDelayedChange">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Generator -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="download" class="w-5 h-5"></i>Export Report</h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hubs</label>
                                <select id="reportHubs" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
                                    <option value="all">All Hubs</option>
                                    <option value="NUNEATON HUB 1">Nuneaton Hub 1</option>
                                    <option value="HUB 2 NUNEATON">Hub 2 Nuneaton</option>
                                    <option value="BRACKNELL HUB">Bracknell Hub</option>
                                    <option value="BRISTOL HUB">Bristol Hub</option>
                                    <option value="HAYDOCK HUB">Haydock Hub</option>
                                    <option value="LEEDS HUB">Leeds Hub</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="exportReport()" class="w-full py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>Performance Report
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500">Performance report includes: Summary metrics, on-time percentages, and daily trends</p>
                    </div>
                </div>

                <!-- Raw Data Export -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mt-6">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5"></i>Export Raw Data
                        </h3>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-slate-600 mb-4">Export all movement data including vehicle details, driver info, trailer numbers, fill percentages, and timing data.</p>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                <input type="date" id="dataExportStartDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                                <input type="date" id="dataExportEndDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hub (Optional)</label>
                                <select id="dataExportHub" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                                    <option value="all">All Hubs</option>
                                    <option value="NUNEATON HUB 1">Nuneaton Hub 1</option>
                                    <option value="HUB 2 NUNEATON">Hub 2 Nuneaton</option>
                                    <option value="BRACKNELL HUB">Bracknell Hub</option>
                                    <option value="BRISTOL HUB">Bristol Hub</option>
                                    <option value="HAYDOCK HUB">Haydock Hub</option>
                                    <option value="LEEDS HUB">Leeds Hub</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="exportRawData()" class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>Export Data
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Includes: Vehicle reg, trailer, driver, fill %, seal, bay, all timestamps, and more</p>
                    </div>
                </div>
            </div>

            <!-- Users View -->
            <div id="view-users" class="view-panel hidden">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i>User Management</h3>
                        <button onclick="openAddUserModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="user-plus" class="w-4 h-4"></i>Add User</button>
                    </div>
                    <div class="table-container"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Username</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Name</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Role</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Location</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Status</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Last Login</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase bg-slate-50">Actions</th>
                    </tr></thead><tbody id="usersBody"></tbody></table></div>
                </div>
            </div>

            <!-- Costing View -->
            <div id="view-costing" class="view-panel hidden">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="pound-sterling" class="w-5 h-5"></i>Costing & Purchase Orders</h3>
                        </div>
                        <!-- Costing Sub-tabs -->
                        <div class="flex flex-wrap gap-1">
                            <button onclick="showCostingTab('contractors')" class="costing-tab-btn active px-3 py-1.5 rounded text-sm font-medium bg-[#0066B3] text-white" data-tab="contractors">Contractors</button>
                            <button onclick="showCostingTab('locations')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="locations">Locations</button>
                            <button onclick="showCostingTab('route-costs')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="route-costs">Route Costs</button>
                            <button onclick="showCostingTab('bank-holidays')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="bank-holidays">Bank Holidays</button>
                            <button onclick="showCostingTab('settings')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="settings">Settings</button>
                            <button onclick="showCostingTab('purchase-orders')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="purchase-orders">Purchase Orders</button>
                            <button onclick="showCostingTab('credit-notes')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="credit-notes">Credit Notes</button>
                            <button onclick="showCostingTab('reports')" class="costing-tab-btn px-3 py-1.5 rounded text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200" data-tab="reports">Reports</button>
                        </div>
                    </div>
                    
                    <!-- Contractors Tab -->
                    <div id="costing-tab-contractors" class="costing-tab-panel p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Contractors / Subcontractors</h4>
                            <button onclick="openContractorModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Add Contractor</button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Code</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Name</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Contact</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Email</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Type</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
                        </tr></thead><tbody id="contractorsBody"></tbody></table></div>
                    </div>
                    
                    <!-- Locations Tab -->
                    <div id="costing-tab-locations" class="costing-tab-panel p-4 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Locations / Depots</h4>
                            <button onclick="openLocationModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Add Location</button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Code</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Name</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Address</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">City</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Postcode</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Type</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
                        </tr></thead><tbody id="locationsBody"></tbody></table></div>
                    </div>
                    
                    <!-- Route Costs Tab -->
                    <div id="costing-tab-route-costs" class="costing-tab-panel p-4 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Route Costs</h4>
                            <button onclick="openRouteCostModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Add Route Cost</button>
                        </div>
                        <div class="flex gap-4 mb-4">
                            <select id="filterRouteCostContractor" onchange="loadRouteCosts()" class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm">
                                <option value="">All Contractors</option>
                            </select>
                            <select id="filterRouteCostRoute" onchange="loadRouteCosts()" class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm">
                                <option value="">All Routes</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Route</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Contractor</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Day Type</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Base Cost</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Effective From</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
                        </tr></thead><tbody id="routeCostsBody"></tbody></table></div>
                    </div>
                    
                    <!-- Bank Holidays Tab -->
                    <div id="costing-tab-bank-holidays" class="costing-tab-panel p-4 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Bank Holidays</h4>
                            <button onclick="openBankHolidayModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Add Bank Holiday</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="bankHolidaysGrid"></div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="costing-tab-settings" class="costing-tab-panel p-4 hidden">
                        <h4 class="font-medium text-slate-700 mb-4">Company Settings</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h5 class="font-medium text-slate-600 border-b pb-2">Company Details</h5>
                                <div><label class="block text-sm text-slate-600 mb-1">Company Name</label><input type="text" id="settingCompanyName" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Address Line 1</label><input type="text" id="settingCompanyAddress1" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Address Line 2</label><input type="text" id="settingCompanyAddress2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm text-slate-600 mb-1">City</label><input type="text" id="settingCompanyCity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                    <div><label class="block text-sm text-slate-600 mb-1">Postcode</label><input type="text" id="settingCompanyPostcode" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h5 class="font-medium text-slate-600 border-b pb-2">Invoice Address</h5>
                                <div><label class="block text-sm text-slate-600 mb-1">Address Line 1</label><input type="text" id="settingInvoiceAddress1" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Address Line 2</label><input type="text" id="settingInvoiceAddress2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm text-slate-600 mb-1">City</label><input type="text" id="settingInvoiceCity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                    <div><label class="block text-sm text-slate-600 mb-1">Postcode</label><input type="text" id="settingInvoicePostcode" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h5 class="font-medium text-slate-600 border-b pb-2">Query Contact</h5>
                                <div><label class="block text-sm text-slate-600 mb-1">Contact Name</label><input type="text" id="settingQueryContactName" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Email</label><input type="email" id="settingQueryContactEmail" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Phone</label><input type="text" id="settingQueryContactPhone" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                            </div>
                            <div class="space-y-4">
                                <h5 class="font-medium text-slate-600 border-b pb-2">Financial Settings</h5>
                                <div><label class="block text-sm text-slate-600 mb-1">VAT Rate (%)</label><input type="number" id="settingVatRate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" step="0.1"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Fuel Surcharge (%)</label><input type="number" id="settingFscPercent" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" step="0.1"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Payment Terms (Days)</label><input type="number" id="settingPaymentDays" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                <div><label class="block text-sm text-slate-600 mb-1">Payment Terms Text</label><input type="text" id="settingPaymentText" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveCompanySettings()" class="px-4 py-2 bg-[#0066B3] text-white rounded-lg text-sm font-medium hover:bg-[#004B87]">Save Settings</button>
                        </div>
                    </div>
                    
                    <!-- Purchase Orders Tab -->
                    <div id="costing-tab-purchase-orders" class="costing-tab-panel p-4 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Purchase Orders</h4>
                            <button onclick="openCreatePOModal()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i>Create PO</button>
                        </div>
                        <div class="flex gap-4 mb-4">
                            <select id="filterPOStatus" onchange="loadPurchaseOrders()" class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="authorised">Authorised</option>
                                <option value="sent">Sent</option>
                            </select>
                            <select id="filterPOContractor" onchange="loadPurchaseOrders()" class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm">
                                <option value="">All Contractors</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">PO Number</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Contractor</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Week</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Created</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
                        </tr></thead><tbody id="purchaseOrdersBody"></tbody></table></div>
                    </div>
                    
                    <!-- Credit Notes Tab -->
                    <div id="costing-tab-credit-notes" class="costing-tab-panel p-4 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-slate-700">Credit Notes</h4>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Credit No.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Against PO</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Contractor</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Created</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
                        </tr></thead><tbody id="creditNotesBody"></tbody></table></div>
                    </div>
                    
                    <!-- Reports Tab -->
                    <div id="costing-tab-reports" class="costing-tab-panel p-4 hidden">
                        <h4 class="font-medium text-slate-700 mb-4">Cost Reports</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <h5 class="font-medium text-slate-600 mb-3">Weekly Cost Report</h5>
                                <div class="space-y-3">
                                    <div><label class="block text-sm text-slate-600 mb-1">From Date</label><input type="date" id="reportFromDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                    <div><label class="block text-sm text-slate-600 mb-1">To Date</label><input type="date" id="reportToDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                                    <button onclick="exportCostReport()" class="w-full px-4 py-2 bg-[#0066B3] text-white rounded-lg text-sm font-medium hover:bg-[#004B87] flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Export to Excel</button>
                                </div>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-4">
                                <h5 class="font-medium text-slate-600 mb-3">Report Summary</h5>
                                <div id="reportSummary" class="text-sm text-slate-600">
                                    <p>Select date range and generate report to see summary.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg hidden slide-in flex items-center gap-3 z-50"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400" id="toastIcon"></i><span id="toastMessage"></span></div>

    <!-- Contractor Modal -->
    <div id="contractorModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="dx-header px-6 py-4 flex items-center justify-between sticky top-0">
                <h2 id="contractorModalTitle" class="text-xl font-bold text-white">Add Contractor</h2>
                <button onclick="closeContractorModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="contractorForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Code *</label><input type="text" id="contractorCode" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm uppercase"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Name *</label><input type="text" id="contractorName" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Address Line 1</label><input type="text" id="contractorAddress1" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Address Line 2</label><input type="text" id="contractorAddress2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">City</label><input type="text" id="contractorCity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Postcode</label><input type="text" id="contractorPostcode" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contact Name</label><input type="text" id="contractorContactName" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contact Phone</label><input type="text" id="contractorContactPhone" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contact Email</label><input type="email" id="contractorContactEmail" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">PO Email (if different)</label><input type="email" id="contractorPOEmail" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">VAT Number</label><input type="text" id="contractorVatNumber" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Payment Terms (Days)</label><input type="number" id="contractorPaymentTerms" value="30" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div class="flex items-end gap-4">
                        <label class="flex items-center gap-2"><input type="checkbox" id="contractorVatRegistered" checked class="rounded"><span class="text-sm">VAT Registered</span></label>
                    </div>
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2"><input type="checkbox" id="contractorIsInternal" class="rounded"><span class="text-sm">Internal (PAYE Staff)</span></label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="contractorActive" checked class="rounded"><span class="text-sm">Active</span></label>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Notes</label><textarea id="contractorNotes" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></textarea></div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeContractorModal()" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                    <button type="button" onclick="saveContractor()" class="flex-1 py-2 bg-[#0066B3] text-white rounded-lg font-medium hover:bg-[#004B87]">Save Contractor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 id="locationModalTitle" class="text-xl font-bold text-white">Add Location</h2>
                <button onclick="closeLocationModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="locationForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Code *</label><input type="text" id="locationCode" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm uppercase"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Name *</label><input type="text" id="locationName" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Address Line 1</label><input type="text" id="locationAddress1" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Address Line 2</label><input type="text" id="locationAddress2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">City</label><input type="text" id="locationCity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Postcode</label><input type="text" id="locationPostcode" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                        <select id="locationType" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            <option value="hub">Hub</option>
                            <option value="depot" selected>Depot</option>
                            <option value="customer">Customer</option>
                        </select>
                    </div>
                    <div class="flex items-end"><label class="flex items-center gap-2"><input type="checkbox" id="locationActive" checked class="rounded"><span class="text-sm">Active</span></label></div>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Notes</label><textarea id="locationNotes" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></textarea></div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeLocationModal()" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                    <button type="button" onclick="saveLocation()" class="flex-1 py-2 bg-[#0066B3] text-white rounded-lg font-medium hover:bg-[#004B87]">Save Location</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Route Cost Modal -->
    <div id="routeCostModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 id="routeCostModalTitle" class="text-xl font-bold text-white">Add Route Cost</h2>
                <button onclick="closeRouteCostModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="routeCostForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Route *</label>
                        <select id="routeCostRoute" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            <option value="">Select Route</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Contractor *</label>
                        <select id="routeCostContractor" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            <option value="">Select Contractor</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Day Type *</label>
                        <select id="routeCostDayType" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            <option value="weekday">Weekday</option>
                            <option value="weekend">Weekend</option>
                            <option value="bank_holiday">Bank Holiday</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Base Cost (¬£) *</label><input type="number" id="routeCostBaseCost" required step="0.01" min="0" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Effective From</label><input type="date" id="routeCostEffectiveFrom" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Effective To</label><input type="date" id="routeCostEffectiveTo" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                </div>
                <div class="flex items-center gap-2"><input type="checkbox" id="routeCostActive" checked class="rounded"><label class="text-sm">Active</label></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Notes</label><textarea id="routeCostNotes" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></textarea></div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeRouteCostModal()" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                    <button type="button" onclick="saveRouteCost()" class="flex-1 py-2 bg-[#0066B3] text-white rounded-lg font-medium hover:bg-[#004B87]">Save Route Cost</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bank Holiday Modal -->
    <div id="bankHolidayModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">Add Bank Holiday</h2>
                <button onclick="closeBankHolidayModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="bankHolidayForm" class="p-6 space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Date *</label><input type="date" id="bankHolidayDate" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Description</label><input type="text" id="bankHolidayDescription" placeholder="e.g. Christmas Day" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeBankHolidayModal()" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                    <button type="button" onclick="saveBankHoliday()" class="flex-1 py-2 bg-[#0066B3] text-white rounded-lg font-medium hover:bg-[#004B87]">Add Holiday</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create PO Modal -->
    <div id="createPOModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="dx-header px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">Create Purchase Order</h2>
                <button onclick="closeCreatePOModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Contractor *</label>
                    <select id="poContractor" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                        <option value="">Select Contractor</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">Week Commencing (Monday) *</label><input type="date" id="poWeekCommencing" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"></div>
                <button type="button" onclick="previewPO()" class="w-full py-2 bg-slate-600 text-white rounded-lg font-medium hover:bg-slate-700">Preview PO</button>
                
                <div id="poPreview" class="hidden border border-slate-200 rounded-lg p-4 mt-4">
                    <h4 class="font-medium text-slate-800 mb-3">PO Preview</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-slate-600">Contractor:</span><span id="poPreviewContractor" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600">Week:</span><span id="poPreviewWeek" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600">Routes:</span><span id="poPreviewLineCount" class="font-medium"></span></div>
                        <hr class="my-2">
                        <div class="flex justify-between"><span class="text-slate-600">Subtotal:</span><span id="poPreviewSubtotal" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600">FSC:</span><span id="poPreviewFSC" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600">VAT:</span><span id="poPreviewVAT" class="font-medium"></span></div>
                        <div class="flex justify-between text-lg"><span class="font-medium">Total:</span><span id="poPreviewTotal" class="font-bold text-[#0066B3]"></span></div>
                    </div>
                    <div class="mt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Notes</label><textarea id="poNotes" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" placeholder="Optional notes for this PO"></textarea></div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeCreatePOModal()" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                    <button type="button" onclick="createPO()" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600">Create PO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ GLOBAL STATE ============
        let authToken = null;
        let currentUser = null;
        let movements = [];
        let auditLog = [];
        let users = [];
        let sortColumn = 'scheduled_dep';
        let sortDirection = 'asc';
        let refreshInterval = null;
        let lastActivity = Date.now();
        let sessionWarningTimeout = null;
        let sessionLogoutTimeout = null;
        let selectedDate = null; // Current selected date
        let datePermissions = null; // User's date access permissions
        let routeFilter = ''; // Current route reference filter
        const SESSION_WARNING_TIME = 25 * 60 * 1000; // 25 minutes
        const SESSION_LOGOUT_TIME = 30 * 60 * 1000;  // 30 minutes
        
        const hubs = ['NUNEATON HUB 1', 'HUB 2 NUNEATON', 'BRACKNELL HUB', 'BRISTOL HUB', 'HAYDOCK HUB', 'LEEDS HUB'];
        const rolePermissions = { 
            'viewer': { canView: true, canLogDeparture: false, canLogArrival: false, canUpdateOps: false, canManageTrunks: false, canManageUsers: false, canAmendTrunk: false, canViewPast: false, canViewFuture: false, canCopyDates: false, canViewCosts: false, canRaisePO: false, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule'] },
            'depot': { canView: true, canLogDeparture: true, canLogArrival: false, canUpdateOps: false, canManageTrunks: false, canManageUsers: false, canAmendTrunk: true, canViewPast: false, canViewFuture: true, canCopyDates: false, canViewCosts: false, canRaisePO: false, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule', 'depot-departure'] },
            'gatehouse': { canView: true, canLogDeparture: false, canLogArrival: true, canUpdateOps: false, canManageTrunks: false, canManageUsers: false, canAmendTrunk: false, canViewPast: false, canViewFuture: false, canCopyDates: false, canViewCosts: false, canRaisePO: false, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['schedule', 'hub-arrival'] },
            'hub-ops': { canView: true, canLogDeparture: true, canLogArrival: true, canUpdateOps: true, canManageTrunks: true, canManageUsers: false, canAmendTrunk: true, canViewPast: false, canViewFuture: false, canCopyDates: false, canViewCosts: false, canRaisePO: false, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule', 'hub-arrival', 'hub-operations', 'metrics'] },
            'supervisor': { canView: true, canLogDeparture: true, canLogArrival: true, canUpdateOps: true, canManageTrunks: true, canManageUsers: false, canAmendTrunk: true, canViewPast: false, canViewFuture: true, canCopyDates: false, canViewCosts: false, canRaisePO: false, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule', 'depot-departure', 'hub-arrival', 'hub-operations', 'metrics'] },
            'planner': { canView: true, canLogDeparture: true, canLogArrival: true, canUpdateOps: true, canManageTrunks: true, canManageUsers: false, canAmendTrunk: true, canViewPast: true, canViewFuture: true, canCopyDates: true, canViewCosts: true, canRaisePO: true, canAuthorisePO: false, canPullReports: false, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule', 'depot-departure', 'hub-arrival', 'hub-operations', 'metrics', 'costing'] },
            'finance': { canView: true, canLogDeparture: false, canLogArrival: false, canUpdateOps: false, canManageTrunks: false, canManageUsers: false, canAmendTrunk: false, canViewPast: true, canViewFuture: true, canCopyDates: false, canViewCosts: true, canRaisePO: false, canAuthorisePO: false, canPullReports: true, canManageCosts: false,
                tabs: ['dashboard', 'live-board', 'schedule', 'metrics', 'costing'] },
            'admin': { canView: true, canLogDeparture: true, canLogArrival: true, canUpdateOps: true, canManageTrunks: true, canManageUsers: true, canAmendTrunk: true, canViewPast: true, canViewFuture: true, canCopyDates: true, canViewCosts: true, canRaisePO: true, canAuthorisePO: true, canPullReports: true, canManageCosts: true,
                tabs: ['dashboard', 'live-board', 'schedule', 'depot-departure', 'hub-arrival', 'hub-operations', 'audit-log', 'metrics', 'costing', 'users'] }
        };
        const roleLabels = { 'viewer': 'Viewer', 'depot': 'Depot Staff', 'gatehouse': 'Gatehouse', 'hub-ops': 'Hub Operations', 'supervisor': 'Supervisor', 'planner': 'Planner', 'finance': 'Finance', 'admin': 'Admin' };
        function getPermissions() { return currentUser ? rolePermissions[currentUser.role] || rolePermissions['viewer'] : rolePermissions['viewer']; }

        // ============ API HELPER WITH AUTH ============
        async function api(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const config = {
                headers: { 
                    'Content-Type': 'application/json'
                },
                ...options
            };
            
            // Add auth token if available
            if (authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            
            const response = await fetch(url, config);
            
            // Handle 401 - session expired
            if (response.status === 401) {
                handleSessionExpired();
                throw new Error('Session expired');
            }
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Request failed' }));
                throw new Error(error.error || 'Request failed');
            }
            
            return response.json();
        }

        // ============ SESSION MANAGEMENT ============
        function resetActivityTimer() {
            lastActivity = Date.now();
            clearTimeout(sessionWarningTimeout);
            clearTimeout(sessionLogoutTimeout);
            
            if (authToken) {
                sessionWarningTimeout = setTimeout(showSessionWarning, SESSION_WARNING_TIME);
                sessionLogoutTimeout = setTimeout(handleSessionExpired, SESSION_LOGOUT_TIME);
            }
        }

        function showSessionWarning() {
            document.getElementById('sessionWarningModal').classList.remove('hidden');
            let countdown = 60;
            const countdownEl = document.getElementById('sessionCountdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            lucide.createIcons();
        }

        function extendSession() {
            document.getElementById('sessionWarningModal').classList.add('hidden');
            resetActivityTimer();
            refreshData(); // This will also validate the token
        }

        function handleSessionExpired() {
            authToken = null;
            currentUser = null;
            clearTimeout(sessionWarningTimeout);
            clearTimeout(sessionLogoutTimeout);
            if (refreshInterval) clearInterval(refreshInterval);
            
            document.getElementById('sessionWarningModal').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginError').textContent = 'Session expired. Please log in again.';
            document.getElementById('loginError').classList.remove('hidden');
        }

        // Track user activity
        document.addEventListener('mousemove', resetActivityTimer);
        document.addEventListener('keypress', resetActivityTimer);
        document.addEventListener('click', resetActivityTimer);

        // ============ PASSWORD STRENGTH ============
        function checkPasswordStrength(inputId, barId, textId) {
            const password = document.getElementById(inputId).value;
            const bar = document.getElementById(barId);
            const text = document.getElementById(textId);
            
            let strength = 0;
            const checks = {
                length: password.length >= 8,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /[0-9]/.test(password)
            };
            
            strength = Object.values(checks).filter(Boolean).length;
            
            // Update requirement indicators
            const prefix = inputId === 'forceNewPassword' ? 'force' : (inputId === 'resetNewPassword' ? 'reset' : '');
            const reqPrefix = prefix ? prefix + 'Req' : 'req';
            
            if (document.getElementById(reqPrefix + '1')) {
                updateReqIndicator(reqPrefix + '1', checks.length);
                updateReqIndicator(reqPrefix + '2', checks.upper);
                updateReqIndicator(reqPrefix + '3', checks.lower);
                updateReqIndicator(reqPrefix + '4', checks.number);
            }
            
            bar.className = 'password-strength';
            if (strength === 0) {
                bar.classList.add('strength-weak');
                bar.style.width = '0%';
                text.textContent = '';
            } else if (strength === 1) {
                bar.classList.add('strength-weak');
                text.textContent = 'Weak';
            } else if (strength === 2) {
                bar.classList.add('strength-fair');
                text.textContent = 'Fair';
            } else if (strength === 3) {
                bar.classList.add('strength-good');
                text.textContent = 'Good';
            } else {
                bar.classList.add('strength-strong');
                text.textContent = 'Strong';
            }
        }

        function updateReqIndicator(id, met) {
            const el = document.getElementById(id);
            if (el) {
                const icon = el.querySelector('i, svg');
                if (icon) {
                    icon.setAttribute('data-lucide', met ? 'check-circle' : 'circle');
                    icon.className = met ? 'w-3 h-3 text-emerald-500' : 'w-3 h-3 text-slate-400';
                }
                el.className = met ? 'flex items-center gap-1 text-emerald-600' : 'flex items-center gap-1';
                lucide.createIcons();
            }
        }

        function validatePassword(password) {
            const errors = [];
            if (password.length < 8) errors.push('at least 8 characters');
            if (!/[A-Z]/.test(password)) errors.push('one uppercase letter');
            if (!/[a-z]/.test(password)) errors.push('one lowercase letter');
            if (!/[0-9]/.test(password)) errors.push('one number');
            return errors;
        }

        // ============ OPERATIONAL TIME SORTING ============
        // Sorts movements by operational day (10:30 ‚Üí 10:29 next day)
        // Times from 10:30-23:59 sort first, then 00:00-10:29
        function sortByOperationalTime(movementsList) {
            return movementsList.sort((a, b) => {
                function toOperationalMinutes(timeStr) {
                    if (!timeStr) return 9999;
                    const parts = timeStr.split(':');
                    if (parts.length !== 2) return 9999;
                    const hours = parseInt(parts[0], 10);
                    const mins = parseInt(parts[1], 10);
                    if (isNaN(hours) || isNaN(mins)) return 9999;
                    
                    let totalMins = hours * 60 + mins;
                    const operationalStart = 630; // 10:30 in minutes
                    
                    if (totalMins >= operationalStart) {
                        return totalMins - operationalStart; // 10:30 = 0, 23:59 = 809
                    } else {
                        return totalMins + (1440 - operationalStart); // 00:00 = 810, 10:29 = 1439
                    }
                }
                return toOperationalMinutes(a.scheduled_dep) - toOperationalMinutes(b.scheduled_dep);
            });
        }

        // Sort by operational arrival time
        function sortByOperationalArrivalTime(movementsList) {
            return movementsList.sort((a, b) => {
                function toOperationalMinutes(timeStr) {
                    if (!timeStr) return 9999;
                    const parts = timeStr.split(':');
                    if (parts.length !== 2) return 9999;
                    const hours = parseInt(parts[0], 10);
                    const mins = parseInt(parts[1], 10);
                    if (isNaN(hours) || isNaN(mins)) return 9999;
                    
                    let totalMins = hours * 60 + mins;
                    const operationalStart = 630;
                    
                    if (totalMins >= operationalStart) {
                        return totalMins - operationalStart;
                    } else {
                        return totalMins + (1440 - operationalStart);
                    }
                }
                return toOperationalMinutes(a.scheduled_arr) - toOperationalMinutes(b.scheduled_arr);
            });
        }

        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            updateClock();
            setInterval(updateClock, 1000);
            populateFilters();
        });

        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('en-GB');
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function populateFilters() {
            const hubOpts = '<option value="">All Hubs</option>' + hubs.map(h => `<option value="${h}">${h}</option>`).join('');
            document.getElementById('liveBoardHubFilter').innerHTML = hubOpts;
            document.getElementById('arrivalHubFilter').innerHTML = hubOpts;
            document.getElementById('opsHubFilter').innerHTML = hubOpts;
            document.getElementById('liveBoardStatusFilter').innerHTML = '<option value="">All Statuses</option><option value="scheduled">Scheduled</option><option value="loading">Loading</option><option value="departed">Departed</option><option value="in-transit">In Transit</option><option value="arrived">Arrived</option><option value="complete">Complete</option><option value="delayed">Delayed</option><option value="cancelled">Cancelled</option>';
            
            // Depot origin filter - get unique origins from movements
            const origins = [...new Set(movements.map(m => m.origin).filter(Boolean))].sort();
            const depotOpts = '<option value="">-- Select Depot --</option>' + origins.map(o => `<option value="${o}">${o}</option>`).join('');
            document.getElementById('depotOriginFilter').innerHTML = depotOpts;
        }

        // ============ AUTH ============
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                document.getElementById('loginError').textContent = 'Please enter username and password';
                document.getElementById('loginError').classList.remove('hidden');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }
                
                authToken = data.token;
                currentUser = data.user;
                
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('loginPassword').value = '';
                
                // Check if password change is required
                if (currentUser.forcePasswordChange) {
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('forcePasswordModal').classList.remove('hidden');
                    lucide.createIcons();
                    return;
                }
                
                completeLogin();
            } catch (err) {
                document.getElementById('loginError').textContent = err.message;
                document.getElementById('loginError').classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function completeLogin() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('forcePasswordModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('displayUsername').textContent = currentUser.fullName;
            document.getElementById('displayRole').textContent = roleLabels[currentUser.role];
            
            applyRolePermissions();
            initializeDateSelector(); // Initialize date selector based on role
            resetActivityTimer();
            refreshData();
            
            refreshInterval = setInterval(refreshData, 30000);
            lucide.createIcons();
        }

        async function forceChangePassword() {
            const currentPwd = document.getElementById('forceCurrentPassword').value;
            const newPwd = document.getElementById('forceNewPassword').value;
            const confirmPwd = document.getElementById('forceConfirmPassword').value;
            
            const errors = validatePassword(newPwd);
            if (errors.length > 0) {
                document.getElementById('forcePasswordError').textContent = `Password must contain ${errors.join(', ')}`;
                document.getElementById('forcePasswordError').classList.remove('hidden');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                document.getElementById('forcePasswordError').textContent = 'Passwords do not match';
                document.getElementById('forcePasswordError').classList.remove('hidden');
                return;
            }
            
            try {
                await api('/auth/change-password', {
                    method: 'POST',
                    body: { currentPassword: currentPwd, newPassword: newPwd }
                });
                
                showToast('Password changed successfully');
                currentUser.forcePasswordChange = false;
                completeLogin();
            } catch (err) {
                document.getElementById('forcePasswordError').textContent = err.message;
                document.getElementById('forcePasswordError').classList.remove('hidden');
            }
        }

        async function logout() {
            try {
                await api('/auth/logout', { method: 'POST' });
            } catch (err) {
                console.error('Logout error:', err);
            }
            
            authToken = null;
            currentUser = null;
            movements = [];
            clearTimeout(sessionWarningTimeout);
            clearTimeout(sessionLogoutTimeout);
            if (refreshInterval) clearInterval(refreshInterval);
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('userMenu').classList.add('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            const btn = e.target.closest('button');
            if (menu && !menu.contains(e.target) && (!btn || !btn.onclick?.toString().includes('toggleUserMenu'))) {
                menu.classList.add('hidden');
            }
        });

        function applyRolePermissions() {
            const perms = getPermissions();
            const allowedTabs = perms.tabs || [];
            
            // Hide/show tabs based on role permissions
            const allTabs = ['dashboard', 'live-board', 'schedule', 'depot-departure', 'hub-arrival', 'hub-operations', 'audit-log', 'metrics', 'users'];
            allTabs.forEach(tab => {
                const tabBtn = document.querySelector(`.tab-${tab}`);
                if (tabBtn) {
                    tabBtn.classList.toggle('hidden', !allowedTabs.includes(tab));
                }
            });
            
            // Show Add Trunk button only for those who can manage trunks
            document.getElementById('addTrunkBtnContainer').classList.toggle('hidden', !perms.canManageTrunks);
            
            // Show action columns only for those who can manage trunks
            document.querySelectorAll('.col-actions').forEach(el => el.classList.toggle('hidden', !perms.canManageTrunks));
            
            // Show edit columns only for those who can amend trunks
            document.querySelectorAll('.col-edit').forEach(el => el.classList.toggle('hidden', !perms.canAmendTrunk));
            
            // If current view is not allowed, switch to first allowed tab
            const currentView = document.querySelector('.view-section:not(.hidden)')?.id?.replace('view-', '');
            if (currentView && !allowedTabs.includes(currentView)) {
                showView(allowedTabs[0] || 'schedule');
            }
        }

        // ============ PASSWORD CHANGE MODAL ============
        function openChangePasswordModal() {
            document.getElementById('userMenu').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('strengthBar').className = 'password-strength';
            document.getElementById('strengthText').textContent = '';
            lucide.createIcons();
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
        }

        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            
            const errors = validatePassword(newPwd);
            if (errors.length > 0) {
                document.getElementById('changePasswordError').textContent = `Password must contain ${errors.join(', ')}`;
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                document.getElementById('changePasswordError').textContent = 'Passwords do not match';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }
            
            try {
                await api('/auth/change-password', {
                    method: 'POST',
                    body: { currentPassword: currentPwd, newPassword: newPwd }
                });
                
                closeChangePasswordModal();
                showToast('Password changed successfully');
            } catch (err) {
                document.getElementById('changePasswordError').textContent = err.message;
                document.getElementById('changePasswordError').classList.remove('hidden');
            }
        }

        // ============ ADMIN PASSWORD RESET ============
        function openResetPasswordModal(userId, userName) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUserName').textContent = userName;
            document.getElementById('resetNewPassword').value = '';
            document.getElementById('resetPasswordError').classList.add('hidden');
            document.getElementById('resetStrengthBar').className = 'password-strength';
            document.getElementById('resetStrengthText').textContent = '';
            document.getElementById('resetPasswordModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.add('hidden');
        }

        async function adminResetPassword() {
            const userId = document.getElementById('resetUserId').value;
            const newPwd = document.getElementById('resetNewPassword').value;
            
            const errors = validatePassword(newPwd);
            if (errors.length > 0) {
                document.getElementById('resetPasswordError').textContent = `Password must contain ${errors.join(', ')}`;
                document.getElementById('resetPasswordError').classList.remove('hidden');
                return;
            }
            
            try {
                await api(`/users/${userId}/reset-password`, {
                    method: 'POST',
                    body: { newPassword: newPwd }
                });
                
                closeResetPasswordModal();
                showToast('Password reset successfully');
                loadUsers();
            } catch (err) {
                document.getElementById('resetPasswordError').textContent = err.message;
                document.getElementById('resetPasswordError').classList.remove('hidden');
            }
        }

        // ============ DATA LOADING ============
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const icon = btn ? (btn.querySelector('svg') || btn.querySelector('i')) : null;
            if (icon) icon.classList.add('refresh-indicator');
            
            try {
                // Build URL with date parameter if selected
                const dateParam = selectedDate ? `?date=${selectedDate}` : '';
                movements = await api(`/movements${dateParam}`);
                auditLog = await api('/audit?limit=50');
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-GB');
                updateRouteRefFilter(); // Update route reference dropdown
                renderAll();
            } catch (err) {
                console.error('Refresh error:', err);
                if (err.message !== 'Session expired') {
                    showToast('Failed to refresh data', 'error');
                }
            } finally {
                if (icon) icon.classList.remove('refresh-indicator');
            }
        }

        function renderAll() {
            updateStats();
            updateDashboard();
            renderLiveBoard();
            renderSchedule();
            updateDepotOriginFilter();
            renderDepotDeparture();
            renderHubArrival();
            renderHubOperations();
            renderAuditLog();
            lucide.createIcons();
        }

        // ============ DATE NAVIGATION ============
        async function initializeDateSelector() {
            try {
                // Get user's date permissions
                datePermissions = await api('/date-permissions');
                selectedDate = datePermissions.today;
                
                const dateSelector = document.getElementById('dateSelector');
                const copyBtn = document.getElementById('copyDateBtn');
                
                // Set initial date value
                dateSelector.value = selectedDate;
                
                // Configure date picker based on permissions
                const perms = getPermissions();
                
                if (!perms.canViewPast && !perms.canViewFuture) {
                    // Today only - disable date picker
                    dateSelector.disabled = true;
                    dateSelector.title = 'Date selection not available for your role';
                } else {
                    dateSelector.disabled = false;
                    
                    // Set min/max based on permissions
                    if (!perms.canViewPast) {
                        dateSelector.min = datePermissions.today;
                    }
                    // Future is unlimited if allowed
                }
                
                // Show/hide copy button
                if (perms.canCopyDates) {
                    copyBtn.classList.remove('hidden');
                } else {
                    copyBtn.classList.add('hidden');
                }
                
            } catch (err) {
                console.error('Error initializing date selector:', err);
            }
        }
        
        async function changeDate() {
            const dateSelector = document.getElementById('dateSelector');
            const newDate = dateSelector.value;
            
            if (!newDate) return;
            
            selectedDate = newDate;
            
            // Visual indicator that we're viewing a different date
            const today = datePermissions?.today;
            const dateLabel = document.getElementById('currentDateLabel');
            const goToTodayBtn = document.getElementById('goToTodayBtn');
            
            if (newDate === today) {
                // Viewing today
                dateLabel.textContent = 'Today';
                dateLabel.className = 'font-semibold text-white';
                dateSelector.classList.remove('ring-2', 'ring-amber-400', 'ring-blue-400');
                goToTodayBtn.classList.add('hidden');
            } else if (newDate < today) {
                // Viewing past date
                dateLabel.textContent = `Past: ${formatDateShort(newDate)}`;
                dateLabel.className = 'font-semibold text-slate-300';
                dateSelector.classList.remove('ring-amber-400');
                dateSelector.classList.add('ring-2', 'ring-blue-400');
                goToTodayBtn.classList.remove('hidden');
            } else {
                // Viewing future date
                dateLabel.textContent = `Future: ${formatDateShort(newDate)}`;
                dateLabel.className = 'font-semibold text-amber-300';
                dateSelector.classList.remove('ring-blue-400');
                dateSelector.classList.add('ring-2', 'ring-amber-400');
                goToTodayBtn.classList.remove('hidden');
            }
            
            await refreshData();
        }
        
        function goToToday() {
            const dateSelector = document.getElementById('dateSelector');
            if (datePermissions?.today) {
                dateSelector.value = datePermissions.today;
                changeDate();
            }
        }
        
        function formatDateShort(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        }

        // ============ ROUTE REFERENCE FILTER ============
        function updateRouteRefFilter() {
            // Get unique route references that have multiple legs
            const routeCounts = {};
            movements.forEach(m => {
                if (m.route_ref) {
                    routeCounts[m.route_ref] = (routeCounts[m.route_ref] || 0) + 1;
                }
            });
            
            // Filter to only routes with multiple legs
            const multiLegRoutes = Object.entries(routeCounts)
                .filter(([ref, count]) => count > 1)
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            const routeSelect = document.getElementById('liveBoardRouteFilter');
            if (routeSelect) {
                const currentValue = routeSelect.value;
                routeSelect.innerHTML = '<option value="">All Routes</option>' + 
                    multiLegRoutes.map(([ref, count]) => 
                        `<option value="${ref}" ${ref === currentValue ? 'selected' : ''}>${ref} (${count} legs)</option>`
                    ).join('');
            }
        }
        
        async function filterByRoute() {
            const routeSelect = document.getElementById('liveBoardRouteFilter');
            routeFilter = routeSelect.value;
            
            if (routeFilter) {
                // Open modal showing all legs for this route
                await showRouteLegs(routeFilter);
            }
            
            renderLiveBoard();
        }
        
        async function showRouteLegs(routeRef) {
            try {
                const dateParam = selectedDate ? `?date=${selectedDate}` : '';
                const data = await api(`/movements/route/${encodeURIComponent(routeRef)}${dateParam}`);
                
                document.getElementById('routeLegsTitle').textContent = routeRef;
                
                const tbody = document.getElementById('routeLegsBody');
                tbody.innerHTML = data.legs.map((leg, idx) => `
                    <tr class="border-b border-slate-100 ${leg.status === 'cancelled' ? 'opacity-50' : ''}">
                        <td class="px-3 py-2 font-semibold">${idx + 1}</td>
                        <td class="px-3 py-2 font-mono">${leg.trunk_id}</td>
                        <td class="px-3 py-2"><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border status-${leg.status}">${leg.status}</span></td>
                        <td class="px-3 py-2">${leg.origin}</td>
                        <td class="px-3 py-2">${leg.destination}</td>
                        <td class="px-3 py-2 font-mono">${leg.scheduled_dep || '‚Äî'}</td>
                        <td class="px-3 py-2 font-mono ${leg.actual_dep ? 'text-blue-600' : ''}">${leg.actual_dep || '‚Äî'}</td>
                        <td class="px-3 py-2 font-mono">${leg.scheduled_arr || '‚Äî'}</td>
                        <td class="px-3 py-2 font-mono ${leg.gate_arrival ? 'text-green-600' : ''}">${leg.gate_arrival || '‚Äî'}</td>
                    </tr>
                `).join('');
                
                document.getElementById('routeLegsModal').classList.remove('hidden');
                lucide.createIcons();
            } catch (err) {
                console.error('Error loading route legs:', err);
                showToast('Failed to load route legs', 'error');
            }
        }
        
        function closeRouteLegsModal() {
            document.getElementById('routeLegsModal').classList.add('hidden');
        }

        // ============ COPY DATE FUNCTIONS ============
        function openCopyDateModal() {
            const today = datePermissions?.today;
            
            // Set up date inputs
            const sourceInput = document.getElementById('copySourceDate');
            const targetInput = document.getElementById('copyTargetDate');
            
            // Source must be in the past
            if (today) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                sourceInput.max = yesterday.toISOString().split('T')[0];
                
                // Default source to yesterday
                sourceInput.value = yesterday.toISOString().split('T')[0];
                
                // Target must be in the future
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                targetInput.min = tomorrow.toISOString().split('T')[0];
                targetInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            document.getElementById('copyDateError').classList.add('hidden');
            document.getElementById('copyDateModal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeCopyDateModal() {
            document.getElementById('copyDateModal').classList.add('hidden');
        }
        
        async function executeCopyDate() {
            const sourceDate = document.getElementById('copySourceDate').value;
            const targetDate = document.getElementById('copyTargetDate').value;
            const errorEl = document.getElementById('copyDateError');
            
            if (!sourceDate || !targetDate) {
                errorEl.textContent = 'Please select both dates';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const result = await api('/copy-date', {
                    method: 'POST',
                    body: { sourceDate, targetDate }
                });
                
                closeCopyDateModal();
                showToast(`Copied ${result.movementsCopied} movements from ${sourceDate} to ${targetDate}`);
                
                // If we're viewing the target date, refresh
                if (selectedDate === targetDate) {
                    await refreshData();
                }
            } catch (err) {
                errorEl.textContent = err.message;
                errorEl.classList.remove('hidden');
            }
        }
        
        function updateDepotOriginFilter() {
            // Update depot origin filter with unique origins from current movements
            const origins = [...new Set(movements.map(m => m.origin).filter(Boolean))].sort();
            const currentValue = document.getElementById('depotOriginFilter')?.value || '';
            const depotOpts = '<option value="">-- Select Depot --</option>' + origins.map(o => `<option value="${o}" ${o === currentValue ? 'selected' : ''}>${o}</option>`).join('');
            if (document.getElementById('depotOriginFilter')) {
                document.getElementById('depotOriginFilter').innerHTML = depotOpts;
            }
        }

        function updateStats() {
            const active = movements.filter(t => t.status !== 'cancelled');
            document.getElementById('statTotal').textContent = active.length;
            document.getElementById('statInbound').textContent = active.filter(t => t.direction === 'INBOUND').length;
            document.getElementById('statOutbound').textContent = active.filter(t => t.direction === 'OUTBOUND').length;
            document.getElementById('statTransfer').textContent = active.filter(t => t.direction === 'TRANSFER').length;
            document.getElementById('statInTransit').textContent = active.filter(t => ['departed', 'in-transit'].includes(t.status)).length;
        }

        function updateDashboard() {
            const active = movements.filter(t => t.status !== 'cancelled');
            document.getElementById('dashStatScheduled').textContent = active.filter(t => t.status === 'scheduled').length;
            document.getElementById('dashStatLoading').textContent = active.filter(t => t.status === 'loading').length;
            document.getElementById('dashStatDeparted').textContent = active.filter(t => t.status === 'departed').length;
            document.getElementById('dashStatInTransit').textContent = active.filter(t => t.status === 'in-transit').length;
            document.getElementById('dashStatArrived').textContent = active.filter(t => t.status === 'arrived').length;
            document.getElementById('dashStatComplete').textContent = active.filter(t => ['docked', 'tipping', 'complete'].includes(t.status)).length;
            document.getElementById('dashStatDelayed').textContent = active.filter(t => t.status === 'delayed').length;
            document.getElementById('dashStatCancelled').textContent = movements.filter(t => t.status === 'cancelled').length;
            
            // Hub cards
            const hubStats = {}; hubs.forEach(h => hubStats[h] = { total: 0, inTransit: 0, arrived: 0, delayed: 0 });
            active.forEach(t => { 
                if (hubStats[t.destination]) { 
                    hubStats[t.destination].total++; 
                    if (['departed', 'in-transit'].includes(t.status)) hubStats[t.destination].inTransit++; 
                    if (['arrived', 'docked', 'complete'].includes(t.status)) hubStats[t.destination].arrived++; 
                    if (t.status === 'delayed') hubStats[t.destination].delayed++; 
                } 
            });
            document.getElementById('hubCards').innerHTML = hubs.map(hub => { 
                const s = hubStats[hub]; 
                return `<div class="hub-card bg-white rounded-xl border border-slate-200 shadow-sm p-4" onclick="filterByHub('${hub}')"><div class="flex items-center justify-between mb-3"><h4 class="font-semibold text-slate-800">${hub}</h4><span class="text-xs bg-slate-100 px-2 py-0.5 rounded">${s.total} trunks</span></div><div class="grid grid-cols-2 gap-2 text-sm"><div class="bg-slate-50 rounded p-2"><p class="text-slate-500 text-xs">Scheduled</p><p class="font-bold">${s.total - s.inTransit - s.arrived}</p></div><div class="bg-blue-50 rounded p-2"><p class="text-blue-600 text-xs">In Transit</p><p class="font-bold text-blue-700">${s.inTransit}</p></div><div class="bg-emerald-50 rounded p-2"><p class="text-emerald-600 text-xs">Arrived</p><p class="font-bold text-emerald-700">${s.arrived}</p></div><div class="bg-red-50 rounded p-2"><p class="text-red-600 text-xs">Delayed</p><p class="font-bold text-red-700">${s.delayed}</p></div></div></div>`; 
            }).join('');
            
            // Recent activity
            document.getElementById('recentActivity').innerHTML = auditLog.slice(0, 10).map(log => `<div class="flex items-start gap-3 py-2 border-b border-slate-100 last:border-0"><div class="w-8 h-8 bg-[#e0f4fc] rounded-full flex items-center justify-center flex-shrink-0"><i data-lucide="activity" class="w-4 h-4 text-[#0099cc]"></i></div><div class="flex-1"><p class="text-sm"><strong>${log.action}</strong> ${log.details || ''}</p><p class="text-xs text-slate-500">${log.user_name} ‚Ä¢ ${new Date(log.created_at).toLocaleTimeString('en-GB')}</p></div></div>`).join('') || '<p class="text-slate-500 text-sm text-center py-4">No recent activity</p>';
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderLiveBoard();
        }

        function renderLiveBoard() {
            const search = document.getElementById('liveBoardSearch')?.value.toLowerCase() || '';
            const hub = document.getElementById('liveBoardHubFilter')?.value || '';
            const status = document.getElementById('liveBoardStatusFilter')?.value || '';
            const direction = document.getElementById('liveBoardDirectionFilter')?.value || '';
            const route = document.getElementById('liveBoardRouteFilter')?.value || '';
            const hideCancelled = document.getElementById('hideCancelled')?.checked;
            const perms = getPermissions();
            
            let filtered = movements.filter(t => {
                if (hideCancelled && t.status === 'cancelled') return false;
                if (search && !Object.values(t).some(v => String(v).toLowerCase().includes(search))) return false;
                if (hub && t.destination !== hub) return false;
                if (status && t.status !== status) return false;
                if (direction && t.direction !== direction) return false;
                if (route && t.route_ref !== route) return false;
                return true;
            });
            
            // Use operational time sorting for time columns
            if (sortColumn === 'scheduled_dep') {
                filtered = sortByOperationalTime(filtered);
                if (sortDirection === 'desc') filtered.reverse();
            } else if (sortColumn === 'scheduled_arr') {
                filtered = sortByOperationalArrivalTime(filtered);
                if (sortDirection === 'desc') filtered.reverse();
            } else {
                filtered.sort((a, b) => {
                    let valA = a[sortColumn] || '';
                    let valB = b[sortColumn] || '';
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            document.getElementById('liveBoardCount').textContent = `(${filtered.length})`;
            document.getElementById('liveBoardBody').innerHTML = filtered.map(t => {
                // Check if this route has multiple legs (clickable)
                const routeClickable = t.route_ref && movements.filter(m => m.route_ref === t.route_ref).length > 1;
                const routeCell = routeClickable 
                    ? `<td class="px-3 py-2 font-mono text-indigo-600 cursor-pointer hover:underline" onclick="showRouteLegs('${t.route_ref}')" title="Click to view all legs">${t.route_ref}</td>`
                    : `<td class="px-3 py-2 font-mono text-slate-600">${t.route_ref || ''}</td>`;
                
                // Check if this is an amended movement
                const amendedBadge = t.is_amendment ? `<span class="ml-1 px-1 py-0.5 text-xs bg-amber-100 text-amber-700 rounded" title="${t.amendment_note || 'Amended'}">A</span>` : '';
                
                return `<tr class="border-b border-slate-100 hover:bg-slate-50 ${t.status === 'cancelled' ? 'opacity-50' : ''}"><td class="px-3 py-2 font-mono font-semibold">${t.trunk_id}${amendedBadge}</td>${routeCell}<td class="px-3 py-2"><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border status-${t.status}">${t.status}</span></td><td class="px-3 py-2"><span class="px-2 py-0.5 text-xs rounded direction-${(t.direction || '').toLowerCase()}">${t.direction || ''}</span></td><td class="px-3 py-2">${t.contractor || ''}</td><td class="px-3 py-2">${t.origin}</td><td class="px-3 py-2">${t.destination}</td><td class="px-3 py-2 font-mono">${t.scheduled_dep || ''}</td><td class="px-3 py-2 font-mono">${t.scheduled_arr || ''}</td><td class="px-3 py-2 col-actions ${perms.canManageTrunks ? '' : 'hidden'}">${t.status !== 'cancelled' && ['scheduled', 'loading'].includes(t.status) ? `<button onclick="cancelTrunk(${t.id})" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">Cancel</button>` : '‚Äî'}</td></tr>`;
            }).join('');
        }

        function renderSchedule() {
            const sorted = sortByOperationalTime([...movements]);
            const perms = getPermissions();
            document.getElementById('scheduleCount').textContent = `(${sorted.length})`;
            document.getElementById('scheduleBody').innerHTML = sorted.map(t => `<tr class="border-b border-slate-100 hover:bg-slate-50 ${t.status === 'cancelled' ? 'opacity-50' : ''}"><td class="px-3 py-2 font-mono font-semibold">${t.trunk_id}</td><td class="px-3 py-2 font-mono text-slate-600">${t.route_ref || ''}</td><td class="px-3 py-2"><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border status-${t.status}">${t.status}</span></td><td class="px-3 py-2"><span class="px-2 py-0.5 text-xs rounded direction-${(t.direction || '').toLowerCase()}">${t.direction || ''}</span></td><td class="px-3 py-2">${t.origin}</td><td class="px-3 py-2">${t.destination}</td><td class="px-3 py-2">${t.contractor || ''}</td><td class="px-3 py-2 font-mono">${t.scheduled_dep || ''}</td><td class="px-3 py-2 font-mono">${t.scheduled_arr || ''}</td><td class="px-3 py-2 col-edit">${t.status !== 'cancelled' && !['complete', 'tipping', 'docked'].includes(t.status) ? `<button onclick="openEditTrunkModal(${t.id})" class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs hover:bg-amber-200"><i data-lucide="edit-2" class="w-3 h-3 inline"></i></button>` : '‚Äî'}</td></tr>`).join('');
            lucide.createIcons();
        }

        function renderDepotDeparture() {
            const depotFilter = document.getElementById('depotOriginFilter')?.value || '';
            let scheduled = movements.filter(t => ['scheduled', 'loading'].includes(t.status));
            
            // Filter by origin depot if selected
            if (depotFilter) {
                scheduled = scheduled.filter(t => t.origin === depotFilter);
                document.getElementById('depotFilterLabel').textContent = `Showing: ${depotFilter}`;
            } else {
                document.getElementById('depotFilterLabel').textContent = 'Select a depot to filter';
            }
            
            scheduled = sortByOperationalTime(scheduled);
            
            document.getElementById('pendingDepCount').textContent = `(${scheduled.length})`;
            
            // Only populate trunk dropdown if depot is selected
            if (depotFilter) {
                document.getElementById('depTrunkSelect').innerHTML = '<option value="">-- Select Trunk --</option>' + scheduled.map(t => `<option value="${t.id}">${t.trunk_id} (${t.route_ref || ''}) ‚Üí ${t.destination}</option>`).join('');
            } else {
                document.getElementById('depTrunkSelect').innerHTML = '<option value="">-- Select Depot First --</option>';
            }
            
            document.getElementById('pendingDeparturesBody').innerHTML = scheduled.slice(0, 100).map(t => `<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono font-semibold">${t.trunk_id}</td><td class="px-3 py-2 font-mono text-slate-600">${t.route_ref || ''}</td><td class="px-3 py-2">${t.contractor || ''}</td><td class="px-3 py-2">${t.origin} ‚Üí ${t.destination}</td><td class="px-3 py-2 font-mono">${t.scheduled_dep || ''}</td><td class="px-3 py-2"><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border status-${t.status}">${t.status}</span></td></tr>`).join('');
            document.getElementById('depTime').value = new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
        }

        function renderHubArrival() {
            const hubFilter = document.getElementById('arrivalHubFilter')?.value || '';
            let inTransit = movements.filter(t => ['departed', 'in-transit'].includes(t.status));
            if (hubFilter) inTransit = inTransit.filter(t => t.destination === hubFilter);
            inTransit = sortByOperationalArrivalTime(inTransit);
            
            document.getElementById('expectedArrCount').textContent = `(${inTransit.length})`;
            document.getElementById('arrTrunkSelect').innerHTML = '<option value="">-- Select --</option>' + inTransit.map(t => `<option value="${t.id}">${t.trunk_id} (${t.route_ref || ''}) ${t.origin}‚Üí${t.destination}</option>`).join('');
            document.getElementById('expectedArrivalsBody').innerHTML = inTransit.map(t => `<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono font-semibold">${t.trunk_id}</td><td class="px-3 py-2 font-mono text-slate-600">${t.route_ref || ''}</td><td class="px-3 py-2">${t.origin}</td><td class="px-3 py-2 font-medium">${t.destination}</td><td class="px-3 py-2 font-mono">${t.actual_dep || '‚Äî'}</td><td class="px-3 py-2 font-mono">${t.scheduled_arr || ''}</td></tr>`).join('');
            document.getElementById('arrGateTime').value = new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
        }

        function renderHubOperations() {
            const hubFilter = document.getElementById('opsHubFilter')?.value || '';
            let docked = movements.filter(t => ['arrived', 'docked', 'tipping'].includes(t.status));
            if (hubFilter) docked = docked.filter(t => t.destination === hubFilter);
            
            document.getElementById('opsTrunkSelect').innerHTML = '<option value="">-- Select --</option>' + docked.map(t => `<option value="${t.id}">${t.trunk_id} (${t.route_ref || ''}) Bay ${t.bay || '?'}</option>`).join('');
            document.getElementById('dockedTrailersBody').innerHTML = docked.map(t => `<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono font-semibold">${t.trunk_id}</td><td class="px-3 py-2 font-mono text-slate-600">${t.route_ref || ''}</td><td class="px-3 py-2 font-bold">${t.bay || '‚Äî'}</td><td class="px-3 py-2 font-medium">${t.destination}</td><td class="px-3 py-2">${t.origin}</td><td class="px-3 py-2 font-mono">${t.gate_arrival || '‚Äî'}</td><td class="px-3 py-2"><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border status-${t.status}">${t.status}</span></td></tr>`).join('');
        }

        function renderAuditLog() {
            document.getElementById('auditLogBody').innerHTML = auditLog.map(l => `<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono text-xs">${new Date(l.created_at).toLocaleString('en-GB')}</td><td class="px-3 py-2">${l.user_name}</td><td class="px-3 py-2 font-medium">${l.action}</td><td class="px-3 py-2">${l.details || ''}</td></tr>`).join('') || '<tr><td colspan="4" class="text-center py-8 text-slate-500">No audit entries</td></tr>';
        }

        // ============ USER MANAGEMENT ============
        async function loadUsers() {
            try {
                users = await api('/users');
                renderUsers();
            } catch (err) {
                console.error('Load users error:', err);
            }
        }

        function renderUsers() {
            document.getElementById('usersBody').innerHTML = users.map(u => {
                const isLocked = u.locked_until && new Date(u.locked_until) > new Date();
                const statusBadge = !u.active ? '<span class="px-2 py-0.5 text-xs rounded bg-red-100 text-red-700">Disabled</span>' :
                    isLocked ? '<span class="px-2 py-0.5 text-xs rounded bg-amber-100 text-amber-700">Locked</span>' :
                    '<span class="px-2 py-0.5 text-xs rounded bg-emerald-100 text-emerald-700">Active</span>';
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString('en-GB') : 'Never';
                
                return `<tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono">${u.username}</td>
                    <td class="px-3 py-2 font-medium">${u.full_name}${u.force_password_change ? ' <span class="text-xs text-amber-600">(must change pwd)</span>' : ''}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 text-xs rounded bg-slate-100">${roleLabels[u.role] || u.role}</span></td>
                    <td class="px-3 py-2">${u.location || '‚Äî'}</td>
                    <td class="px-3 py-2">${statusBadge}</td>
                    <td class="px-3 py-2 text-xs text-slate-500">${lastLogin}</td>
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-1">
                            ${isLocked ? `<button onclick="unlockUser(${u.id})" class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs hover:bg-amber-200" title="Unlock account">Unlock</button>` : ''}
                            <button onclick="openResetPasswordModal(${u.id}, '${u.full_name}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200" title="Reset password">Reset Pwd</button>
                            <button onclick="forceLogoutUser(${u.id})" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200" title="Force logout">Logout</button>
                            <button onclick="toggleUser(${u.id})" class="px-2 py-1 ${u.active ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'} rounded text-xs">${u.active ? 'Disable' : 'Enable'}</button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" class="text-center py-8 text-slate-500">No users found</td></tr>';
        }

        async function toggleUser(id) {
            try {
                await api(`/users/${id}/toggle`, { method: 'PATCH' });
                showToast('User status updated');
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function unlockUser(id) {
            try {
                await api(`/users/${id}/unlock`, { method: 'PATCH' });
                showToast('User account unlocked');
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function forceLogoutUser(id) {
            if (!confirm('This will terminate all active sessions for this user. Continue?')) return;
            try {
                await api(`/users/${id}/force-logout`, { method: 'POST' });
                showToast('User sessions terminated');
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // ============ ADD USER MODAL ============
        function openAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('newUsername').value = '';
            document.getElementById('newFullName').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newRole').value = 'viewer';
            document.getElementById('newLocation').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('addUserError').classList.add('hidden');
            document.getElementById('newUserStrengthBar').className = 'password-strength';
            document.getElementById('newUserStrengthText').textContent = '';
            lucide.createIcons();
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const fullName = document.getElementById('newFullName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const role = document.getElementById('newRole').value;
            const location = document.getElementById('newLocation').value.trim();
            const password = document.getElementById('newUserPassword').value;
            
            // Validation
            if (!username || !fullName || !password) {
                document.getElementById('addUserError').textContent = 'Username, full name and password are required';
                document.getElementById('addUserError').classList.remove('hidden');
                return;
            }
            
            const errors = validatePassword(password);
            if (errors.length > 0) {
                document.getElementById('addUserError').textContent = `Password must contain ${errors.join(', ')}`;
                document.getElementById('addUserError').classList.remove('hidden');
                return;
            }
            
            try {
                await api('/users', {
                    method: 'POST',
                    body: {
                        username,
                        full_name: fullName,
                        email,
                        role,
                        location,
                        password
                    }
                });
                
                closeAddUserModal();
                showToast(`User ${fullName} created successfully`);
                loadUsers();
            } catch (err) {
                document.getElementById('addUserError').textContent = err.message;
                document.getElementById('addUserError').classList.remove('hidden');
            }
        }

        // ============ ADD TRUNK MODAL ============
        function openAddTrunkModal() {
            document.getElementById('addTrunkModal').classList.remove('hidden');
            document.getElementById('newTrunkId').value = '';
            document.getElementById('newRouteRef').value = '';
            document.getElementById('newOrigin').value = '';
            document.getElementById('newDestination').value = '';
            document.getElementById('newDirection').value = 'INBOUND';
            document.getElementById('newSchedDep').value = '';
            document.getElementById('newSchedArr').value = '';
            document.getElementById('newContractor').value = '';
            document.getElementById('newVehicleType').value = 'ARTIC';
            document.getElementById('customOriginContainer').classList.add('hidden');
            document.getElementById('customDestinationContainer').classList.add('hidden');
            document.getElementById('addTrunkError').classList.add('hidden');
            
            // Add change listeners for custom origin/destination
            document.getElementById('newOrigin').onchange = function() {
                document.getElementById('customOriginContainer').classList.toggle('hidden', this.value !== 'OTHER');
            };
            document.getElementById('newDestination').onchange = function() {
                document.getElementById('customDestinationContainer').classList.toggle('hidden', this.value !== 'OTHER');
            };
            
            lucide.createIcons();
        }

        function closeAddTrunkModal() {
            document.getElementById('addTrunkModal').classList.add('hidden');
        }

        async function createTrunk() {
            const trunkId = document.getElementById('newTrunkId').value.trim().toUpperCase();
            const routeRef = document.getElementById('newRouteRef').value.trim().toUpperCase();
            let origin = document.getElementById('newOrigin').value;
            let destination = document.getElementById('newDestination').value;
            const direction = document.getElementById('newDirection').value;
            const schedDep = document.getElementById('newSchedDep').value;
            const schedArr = document.getElementById('newSchedArr').value;
            const contractor = document.getElementById('newContractor').value.trim().toUpperCase();
            const vehicleType = document.getElementById('newVehicleType').value;
            
            // Handle custom origin/destination
            if (origin === 'OTHER') {
                origin = document.getElementById('customOrigin').value.trim().toUpperCase();
            }
            if (destination === 'OTHER') {
                destination = document.getElementById('customDestination').value.trim().toUpperCase();
            }
            
            // Validation
            if (!trunkId || !origin || !destination) {
                document.getElementById('addTrunkError').textContent = 'Trunk ID, Origin and Destination are required';
                document.getElementById('addTrunkError').classList.remove('hidden');
                return;
            }
            
            try {
                await api('/movements', {
                    method: 'POST',
                    body: {
                        trunk_id: trunkId,
                        route_ref: routeRef,
                        origin,
                        destination,
                        direction,
                        scheduled_dep: schedDep,
                        scheduled_arr: schedArr,
                        contractor,
                        vehicle_type: vehicleType
                    }
                });
                
                closeAddTrunkModal();
                showToast(`Trunk ${trunkId} added successfully`);
                await refreshData();
            } catch (err) {
                document.getElementById('addTrunkError').textContent = err.message;
                document.getElementById('addTrunkError').classList.remove('hidden');
            }
        }

        // ============ ACTIONS ============
        async function logDeparture() {
            const id = document.getElementById('depTrunkSelect').value;
            if (!id) { showToast('Select trunk', 'error'); return; }
            
            try {
                await api(`/movements/${id}`, {
                    method: 'PATCH',
                    body: {
                        status: 'departed',
                        vehicle_reg: document.getElementById('depVehicleReg').value,
                        trailer: document.getElementById('depTrailer').value,
                        driver: document.getElementById('depDriverName').value,
                        actual_dep: document.getElementById('depTime').value,
                        fill_percent: parseInt(document.getElementById('depFill').value) || 0,
                        seal: document.getElementById('depSeal').value
                    }
                });
                
                showToast('Departure logged');
                await refreshData();
                
                document.getElementById('depVehicleReg').value = '';
                document.getElementById('depTrailer').value = '';
                document.getElementById('depDriverName').value = '';
                document.getElementById('depFill').value = '';
                document.getElementById('depSeal').value = '';
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function logArrival() {
            const id = document.getElementById('arrTrunkSelect').value;
            if (!id) { showToast('Select trunk', 'error'); return; }
            
            try {
                await api(`/movements/${id}`, {
                    method: 'PATCH',
                    body: {
                        status: 'arrived',
                        gate_arrival: document.getElementById('arrGateTime').value,
                        bay: document.getElementById('arrBay').value
                    }
                });
                
                showToast('Arrival logged');
                await refreshData();
                
                document.getElementById('arrSealVerify').value = '';
                document.getElementById('arrBay').value = '';
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function updateOperations() {
            const id = document.getElementById('opsTrunkSelect').value;
            if (!id) { showToast('Select trunk', 'error'); return; }
            
            const updates = {};
            const tipComplete = document.getElementById('opsTipComplete').value;
            const tipStart = document.getElementById('opsTipStart').value;
            const dockTime = document.getElementById('opsDockTime').value;
            
            if (tipComplete) {
                updates.status = 'complete';
                updates.tip_complete = tipComplete;
            } else if (tipStart) {
                updates.status = 'tipping';
                updates.tip_start = tipStart;
            } else if (dockTime) {
                updates.status = 'docked';
                updates.dock_time = dockTime;
            }
            
            if (Object.keys(updates).length === 0) {
                showToast('Enter at least one time', 'error');
                return;
            }
            
            try {
                await api(`/movements/${id}`, { method: 'PATCH', body: updates });
                showToast('Operations updated');
                await refreshData();
                
                document.getElementById('opsDockTime').value = '';
                document.getElementById('opsTipStart').value = '';
                document.getElementById('opsTipComplete').value = '';
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function cancelTrunk(id) {
            const reason = prompt('Cancellation reason:');
            if (!reason) return;
            
            try {
                await api(`/movements/${id}`, {
                    method: 'PATCH',
                    body: { status: 'cancelled', cancel_reason: reason }
                });
                showToast('Trunk cancelled');
                await refreshData();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // ============ NAVIGATION ============
        function showView(viewName) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === viewName) btn.classList.add('active');
            });
            
            // Load users when switching to users view
            if (viewName === 'users' && getPermissions().canManageUsers) {
                loadUsers();
            }
            
            // Load metrics when switching to metrics view
            if (viewName === 'metrics') {
                refreshMetrics();
                initReportDates();
                initDataExportDates();
                loadDailyReports();
                initCompareDates();
            }
            
            // Load costing data when switching to costing view
            if (viewName === 'costing' && getPermissions().canViewCosts) {
                loadContractors();
            }
            
            lucide.createIcons();
        }
        
        function initCompareDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const twoDaysAgo = new Date(today);
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            
            document.getElementById('compareDate1').value = twoDaysAgo.toISOString().split('T')[0];
            document.getElementById('compareDate2').value = yesterday.toISOString().split('T')[0];
        }

        function filterByStatus(status) {
            document.getElementById('liveBoardStatusFilter').value = status;
            showView('live-board');
            renderLiveBoard();
        }

        function filterByHub(hub) {
            document.getElementById('liveBoardHubFilter').value = hub;
            showView('live-board');
            renderLiveBoard();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            const icon = document.getElementById('toastIcon');
            icon.setAttribute('data-lucide', type === 'error' ? 'x-circle' : 'check-circle');
            icon.className = `w-5 h-5 ${type === 'error' ? 'text-red-400' : 'text-emerald-400'}`;
            lucide.createIcons();
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ============ METRICS ============
        function getPerformanceColor(percent) {
            if (percent >= 95) return { bg: 'bg-emerald-100', text: 'text-emerald-700' };
            if (percent >= 90) return { bg: 'bg-amber-100', text: 'text-amber-700' };
            return { bg: 'bg-red-100', text: 'text-red-700' };
        }

        async function refreshMetrics() {
            const refreshBtn = document.getElementById('networkRefreshBtn');
            const refreshIcon = refreshBtn?.querySelector('i');
            
            try {
                // Show loading state
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.classList.add('opacity-70');
                }
                if (refreshIcon) {
                    refreshIcon.classList.add('animate-spin');
                }
                
                const data = await api('/metrics/live');
                renderNetworkMetrics(data.network);
                renderHubMetrics(data.hubs);
                showToast('Network metrics refreshed');
            } catch (err) {
                console.error('Metrics error:', err);
                showToast('Failed to load metrics', 'error');
            } finally {
                // Reset button state
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('opacity-70');
                }
                if (refreshIcon) {
                    refreshIcon.classList.remove('animate-spin');
                }
            }
        }

        function renderNetworkMetrics(m) {
            document.getElementById('metricTotal').textContent = m.total;
            document.getElementById('metricDeparted').textContent = m.departed;
            document.getElementById('metricArrived').textContent = m.arrived;
            document.getElementById('metricComplete').textContent = m.complete;
            document.getElementById('metricToGo').textContent = m.total - m.complete;
            document.getElementById('metricDepOnTime').textContent = m.depOnTimePercent + '%';
            document.getElementById('metricArrOnTime').textContent = m.arrOnTimePercent + '%';
            document.getElementById('metricDepMinsLost').textContent = m.depMinsLost;
            document.getElementById('metricArrMinsLost').textContent = m.arrMinsLost;
            document.getElementById('metricAvgTurnaround').textContent = m.avgTurnaround;
            document.getElementById('metricAvgTip').textContent = m.avgTipDuration;

            // Color code on-time percentages
            const depColor = getPerformanceColor(m.depOnTimePercent);
            const arrColor = getPerformanceColor(m.arrOnTimePercent);
            
            const depCard = document.getElementById('metricDepOnTimeCard');
            depCard.className = `rounded-lg p-4 text-center ${depColor.bg}`;
            document.getElementById('metricDepOnTime').className = `text-3xl font-bold ${depColor.text}`;
            
            const arrCard = document.getElementById('metricArrOnTimeCard');
            arrCard.className = `rounded-lg p-4 text-center ${arrColor.bg}`;
            document.getElementById('metricArrOnTime').className = `text-3xl font-bold ${arrColor.text}`;
            
            // Color code Trunks To Go - green when 0, orange otherwise
            const toGo = m.total - m.complete;
            const toGoCard = document.getElementById('metricToGo').parentElement;
            if (toGo === 0) {
                toGoCard.className = 'bg-emerald-50 rounded-lg p-4 text-center border-2 border-emerald-300';
                document.getElementById('metricToGo').className = 'text-3xl font-bold text-emerald-600';
            } else {
                toGoCard.className = 'bg-orange-50 rounded-lg p-4 text-center border-2 border-orange-200';
                document.getElementById('metricToGo').className = 'text-3xl font-bold text-orange-600';
            }
        }

        function renderHubMetrics(hubData) {
            const tbody = document.getElementById('hubMetricsBody');
            tbody.innerHTML = hubs.map(hub => {
                const m = hubData[hub] || { total: 0, departed: 0, arrived: 0, complete: 0, depOnTimePercent: 0, arrOnTimePercent: 0, depMinsLost: 0, arrMinsLost: 0, avgTurnaround: 0 };
                const depColor = getPerformanceColor(m.depOnTimePercent);
                const arrColor = getPerformanceColor(m.arrOnTimePercent);
                
                return `<tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-4 py-3 font-medium">${hub}</td>
                    <td class="px-4 py-3 text-center">${m.total}</td>
                    <td class="px-4 py-3 text-center">${m.departed}</td>
                    <td class="px-4 py-3 text-center">${m.arrived}</td>
                    <td class="px-4 py-3 text-center">${m.complete}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded ${depColor.bg} ${depColor.text} font-medium">${m.depOnTimePercent}%</span></td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded ${arrColor.bg} ${arrColor.text} font-medium">${m.arrOnTimePercent}%</span></td>
                    <td class="px-4 py-3 text-center ${m.depMinsLost > 0 ? 'text-red-600 font-medium' : ''}">${m.depMinsLost}</td>
                    <td class="px-4 py-3 text-center ${m.arrMinsLost > 0 ? 'text-red-600 font-medium' : ''}">${m.arrMinsLost}</td>
                    <td class="px-4 py-3 text-center">${m.avgTurnaround}</td>
                </tr>`;
            }).join('');
        }

        function initReportDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
        }

        async function exportReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const hubs = document.getElementById('reportHubs').value;
            
            if (!startDate || !endDate) {
                showToast('Please select start and end dates', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showToast('Start date must be before end date', 'error');
                return;
            }
            
            try {
                showToast('Generating report...');
                
                // Fetch the file directly
                const response = await fetch(`/api/report/export?startDate=${startDate}&endDate=${endDate}&hubs=${hubs}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `TMS_Report_${startDate}_to_${endDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Report downloaded');
            } catch (err) {
                console.error('Export error:', err);
                showToast('Failed to export report', 'error');
            }
        }

        async function exportRawData() {
            const startDate = document.getElementById('dataExportStartDate').value;
            const endDate = document.getElementById('dataExportEndDate').value;
            const hub = document.getElementById('dataExportHub').value;
            
            if (!startDate || !endDate) {
                showToast('Please select start and end dates', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showToast('Start date must be before end date', 'error');
                return;
            }
            
            try {
                showToast('Exporting data...');
                
                // Fetch the file directly
                const response = await fetch(`/api/export/data?startDate=${startDate}&endDate=${endDate}&hub=${hub}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `TMS_Data_Export_${startDate}_to_${endDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Data exported successfully');
            } catch (err) {
                console.error('Export error:', err);
                showToast('Failed to export data', 'error');
            }
        }

        function initDataExportDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dataExportStartDate').value = today;
            document.getElementById('dataExportEndDate').value = today;
        }

        // ============ EDIT TRUNK FUNCTIONS ============
        function openEditTrunkModal(movementId) {
            const movement = movements.find(m => m.id === movementId);
            if (!movement) {
                showToast('Movement not found', 'error');
                return;
            }
            
            document.getElementById('editTrunkMovementId').value = movementId;
            document.getElementById('editTrunkDisplay').textContent = movement.trunk_id;
            document.getElementById('editRouteDisplay').textContent = `${movement.origin} ‚Üí ${movement.destination}`;
            document.getElementById('editContractor').value = movement.contractor || '';
            document.getElementById('editVehicleType').value = movement.vehicle_type || 'ARTIC';
            document.getElementById('editVehicleReg').value = movement.vehicle_reg || '';
            document.getElementById('editTrailer').value = movement.trailer || '';
            document.getElementById('editDriverName').value = movement.driver || '';
            document.getElementById('editDriverMobile').value = movement.driver_mobile || '';
            document.getElementById('editSchedDep').value = movement.scheduled_dep || '';
            document.getElementById('editSchedArr').value = movement.scheduled_arr || '';
            
            document.getElementById('editTrunkModal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeEditTrunkModal() {
            document.getElementById('editTrunkModal').classList.add('hidden');
            document.getElementById('editTrunkError').classList.add('hidden');
        }
        
        async function saveEditTrunk() {
            const movementId = document.getElementById('editTrunkMovementId').value;
            
            const updates = {
                contractor: document.getElementById('editContractor').value,
                vehicle_type: document.getElementById('editVehicleType').value,
                vehicle_reg: document.getElementById('editVehicleReg').value,
                trailer: document.getElementById('editTrailer').value,
                driver: document.getElementById('editDriverName').value,
                driver_mobile: document.getElementById('editDriverMobile').value,
                scheduled_dep: document.getElementById('editSchedDep').value,
                scheduled_arr: document.getElementById('editSchedArr').value
            };
            
            try {
                await api(`/movements/${movementId}`, {
                    method: 'PATCH',
                    body: updates
                });
                
                closeEditTrunkModal();
                showToast('Trunk updated successfully');
                refreshData();
            } catch (err) {
                document.getElementById('editTrunkError').textContent = err.message;
                document.getElementById('editTrunkError').classList.remove('hidden');
            }
        }

        // ============ DAILY REPORTS FUNCTIONS ============
        async function loadDailyReports() {
            const days = document.getElementById('dailyReportDays')?.value || 7;
            
            try {
                const reports = await api(`/daily-reports?days=${days}`);
                renderDailyReports(reports);
            } catch (err) {
                console.error('Load daily reports error:', err);
                document.getElementById('dailyReportsBody').innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-500">No reports available yet. Reports are generated at 5am daily.</td></tr>';
            }
        }
        
        function renderDailyReports(reports) {
            if (!reports || reports.length === 0) {
                document.getElementById('dailyReportsBody').innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-500">No reports available yet. Reports are generated at 5am daily.</td></tr>';
                return;
            }
            
            document.getElementById('dailyReportsBody').innerHTML = reports.map(r => {
                const completionColor = getPerformanceColor(parseFloat(r.completion_rate));
                const depOtpColor = getPerformanceColor(parseFloat(r.departure_otp));
                const arrOtpColor = getPerformanceColor(parseFloat(r.arrival_otp));
                const reportDate = new Date(r.report_date).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                const dateStr = r.report_date.split('T')[0];
                
                return `<tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-4 py-3 font-medium">${reportDate}</td>
                    <td class="px-4 py-3 text-center">${r.total_movements}</td>
                    <td class="px-4 py-3 text-center">${r.completed_count}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded ${completionColor.bg} ${completionColor.text} font-medium">${r.completion_rate}%</span></td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded ${depOtpColor.bg} ${depOtpColor.text} font-medium">${r.departure_otp}%</span></td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded ${arrOtpColor.bg} ${arrOtpColor.text} font-medium">${r.arrival_otp}%</span></td>
                    <td class="px-4 py-3 text-center ${r.delayed_count > 0 ? 'text-red-600 font-medium' : ''}">${r.delayed_count}</td>
                    <td class="px-4 py-3 text-center text-slate-500">${r.cancelled_count}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="viewDailyReport('${dateStr}')" class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs hover:bg-slate-200">View</button>
                            <button onclick="exportDailyReportDirect('${dateStr}')" class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs hover:bg-emerald-200" title="Export to Excel"><i data-lucide="download" class="w-3 h-3"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }
        
        let currentDailyReportDate = null;
        
        async function viewDailyReport(dateStr) {
            currentDailyReportDate = dateStr;
            try {
                const report = await api(`/daily-reports/${dateStr}`);
                
                const reportDate = new Date(report.report_date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('reportDetailDate').textContent = reportDate;
                document.getElementById('reportDetailTotal').textContent = report.total_movements;
                document.getElementById('reportDetailCompletion').textContent = report.completion_rate + '%';
                document.getElementById('reportDetailDepOtp').textContent = report.departure_otp + '%';
                document.getElementById('reportDetailArrOtp').textContent = report.arrival_otp + '%';
                
                // Color code OTP cards
                const depColor = getPerformanceColor(parseFloat(report.departure_otp));
                const arrColor = getPerformanceColor(parseFloat(report.arrival_otp));
                document.getElementById('reportDetailDepOtpCard').className = `rounded-lg p-3 text-center ${depColor.bg}`;
                document.getElementById('reportDetailDepOtp').className = `text-2xl font-bold ${depColor.text}`;
                document.getElementById('reportDetailArrOtpCard').className = `rounded-lg p-3 text-center ${arrColor.bg}`;
                document.getElementById('reportDetailArrOtp').className = `text-2xl font-bold ${arrColor.text}`;
                
                // Hub breakdown
                const hubBreakdown = report.hub_breakdown || {};
                document.getElementById('reportDetailHubBody').innerHTML = Object.entries(hubBreakdown).map(([hub, data]) => 
                    `<tr class="border-b border-slate-100"><td class="px-3 py-2">${hub}</td><td class="px-3 py-2 text-center">${data.total}</td><td class="px-3 py-2 text-center">${data.completed}</td><td class="px-3 py-2 text-center">${data.inProgress}</td><td class="px-3 py-2 text-center ${data.delayed > 0 ? 'text-red-600' : ''}">${data.delayed}</td></tr>`
                ).join('') || '<tr><td colspan="5" class="text-center py-4 text-slate-500">No hub data</td></tr>';
                
                // Contractor breakdown
                const contractorBreakdown = report.contractor_breakdown || {};
                document.getElementById('reportDetailContractorBody').innerHTML = Object.entries(contractorBreakdown).map(([contractor, data]) => 
                    `<tr class="border-b border-slate-100"><td class="px-3 py-2">${contractor}</td><td class="px-3 py-2 text-center">${data.total}</td><td class="px-3 py-2 text-center">${data.completed}</td><td class="px-3 py-2 text-center ${data.delayed > 0 ? 'text-red-600' : ''}">${data.delayed}</td></tr>`
                ).join('') || '<tr><td colspan="4" class="text-center py-4 text-slate-500">No contractor data</td></tr>';
                
                // Delayed movements
                const delayedMovements = report.delayed_movements || [];
                if (delayedMovements.length > 0) {
                    document.getElementById('reportDetailDelayedSection').classList.remove('hidden');
                    document.getElementById('reportDetailDelayedBody').innerHTML = delayedMovements.map(d => 
                        `<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono">${d.trunkId}</td><td class="px-3 py-2">${d.routeRef || ''}</td><td class="px-3 py-2">${d.contractor || ''}</td><td class="px-3 py-2">${d.origin} ‚Üí ${d.destination}</td></tr>`
                    ).join('');
                } else {
                    document.getElementById('reportDetailDelayedSection').classList.add('hidden');
                }
                
                document.getElementById('dailyReportModal').classList.remove('hidden');
            } catch (err) {
                console.error('View report error:', err);
                showToast('Failed to load report details', 'error');
            }
        }
        
        function closeDailyReportModal() {
            document.getElementById('dailyReportModal').classList.add('hidden');
        }
        
        async function exportDailyReport() {
            if (!currentDailyReportDate) {
                showToast('No report selected', 'error');
                return;
            }
            
            await exportDailyReportDirect(currentDailyReportDate);
        }
        
        async function exportDailyReportDirect(dateStr) {
            try {
                showToast('Generating report...');
                
                const response = await fetch(`/api/daily-reports/${dateStr}/export`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DX_Daily_Report_${dateStr}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Report downloaded');
            } catch (err) {
                console.error('Export error:', err);
                showToast('Failed to export report', 'error');
            }
        }
        
        async function compareDays() {
            const date1 = document.getElementById('compareDate1').value;
            const date2 = document.getElementById('compareDate2').value;
            
            if (!date1 || !date2) {
                showToast('Please select both dates', 'error');
                return;
            }
            
            try {
                const comparison = await api(`/daily-reports/compare/${date1}/${date2}`);
                
                document.getElementById('comparisonResult').classList.remove('hidden');
                
                // Completion Rate
                document.getElementById('compareCompletion').textContent = `${comparison.report2.completion_rate}%`;
                const compChange = parseFloat(comparison.changes.completionRate.change);
                document.getElementById('compareCompletionChange').textContent = `${compChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(compChange)}%`;
                document.getElementById('compareCompletionChange').className = `text-xs ${compChange >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                
                // Dep OTP
                document.getElementById('compareDepOtp').textContent = `${comparison.report2.departure_otp}%`;
                const depChange = parseFloat(comparison.changes.departureOtp.change);
                document.getElementById('compareDepOtpChange').textContent = `${depChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(depChange)}%`;
                document.getElementById('compareDepOtpChange').className = `text-xs ${depChange >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                
                // Arr OTP
                document.getElementById('compareArrOtp').textContent = `${comparison.report2.arrival_otp}%`;
                const arrChange = parseFloat(comparison.changes.arrivalOtp.change);
                document.getElementById('compareArrOtpChange').textContent = `${arrChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(arrChange)}%`;
                document.getElementById('compareArrOtpChange').className = `text-xs ${arrChange >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                
                // Delayed (lower is better)
                document.getElementById('compareDelayed').textContent = comparison.report2.delayed_count;
                const delayChange = comparison.changes.delayedCount.change;
                document.getElementById('compareDelayedChange').textContent = `${delayChange <= 0 ? '‚Üì' : '‚Üë'} ${Math.abs(delayChange)}`;
                document.getElementById('compareDelayedChange').className = `text-xs ${delayChange <= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                
            } catch (err) {
                console.error('Compare error:', err);
                showToast('Failed to compare dates. Make sure reports exist for both dates.', 'error');
            }
        }

        // ============ COSTING MODULE ============
        
        let contractors = [];
        let locations = [];
        let routeCosts = [];
        let bankHolidays = [];
        let companySettings = {};
        let purchaseOrders = [];
        let creditNotes = [];
        let editingContractorId = null;
        let editingLocationId = null;
        let editingRouteCostId = null;
        
        // Show costing sub-tab
        function showCostingTab(tabName) {
            document.querySelectorAll('.costing-tab-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.costing-tab-btn').forEach(b => {
                b.classList.remove('bg-[#0066B3]', 'text-white');
                b.classList.add('bg-slate-100', 'text-slate-600');
            });
            
            document.getElementById(`costing-tab-${tabName}`).classList.remove('hidden');
            const btn = document.querySelector(`.costing-tab-btn[data-tab="${tabName}"]`);
            if (btn) {
                btn.classList.remove('bg-slate-100', 'text-slate-600');
                btn.classList.add('bg-[#0066B3]', 'text-white');
            }
            
            // Load data for the tab
            switch(tabName) {
                case 'contractors': loadContractors(); break;
                case 'locations': loadLocations(); break;
                case 'route-costs': loadRouteCosts(); loadRouteCostFilters(); break;
                case 'bank-holidays': loadBankHolidays(); break;
                case 'settings': loadCompanySettings(); break;
                case 'purchase-orders': loadPurchaseOrders(); loadPOFilters(); break;
                case 'credit-notes': loadCreditNotes(); break;
                case 'reports': initCostingReportDates(); break;
            }
        }
        
        // ============ CONTRACTORS ============
        
        async function loadContractors() {
            try {
                contractors = await api('/contractors');
                renderContractors();
            } catch (err) {
                console.error('Load contractors error:', err);
                showToast('Failed to load contractors', 'error');
            }
        }
        
        function renderContractors() {
            const body = document.getElementById('contractorsBody');
            if (!body) return;
            
            body.innerHTML = contractors.map(c => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-sm">${c.code}</td>
                    <td class="px-3 py-2">${c.name}</td>
                    <td class="px-3 py-2">${c.contact_name || '-'}</td>
                    <td class="px-3 py-2 text-sm">${c.po_email || c.contact_email || '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${c.is_internal ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}">${c.is_internal ? 'Internal' : 'External'}</span></td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${c.active ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${c.active ? 'Active' : 'Inactive'}</span></td>
                    <td class="px-3 py-2">
                        <button onclick="editContractor(${c.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openContractorModal(id = null) {
            editingContractorId = id;
            const modal = document.getElementById('contractorModal');
            const title = document.getElementById('contractorModalTitle');
            
            if (id) {
                title.textContent = 'Edit Contractor';
                const c = contractors.find(x => x.id === id);
                if (c) {
                    document.getElementById('contractorCode').value = c.code || '';
                    document.getElementById('contractorName').value = c.name || '';
                    document.getElementById('contractorAddress1').value = c.address_line1 || '';
                    document.getElementById('contractorAddress2').value = c.address_line2 || '';
                    document.getElementById('contractorCity').value = c.city || '';
                    document.getElementById('contractorPostcode').value = c.postcode || '';
                    document.getElementById('contractorContactName').value = c.contact_name || '';
                    document.getElementById('contractorContactEmail').value = c.contact_email || '';
                    document.getElementById('contractorContactPhone').value = c.contact_phone || '';
                    document.getElementById('contractorPOEmail').value = c.po_email || '';
                    document.getElementById('contractorVatRegistered').checked = c.vat_registered;
                    document.getElementById('contractorVatNumber').value = c.vat_number || '';
                    document.getElementById('contractorPaymentTerms').value = c.payment_terms || 30;
                    document.getElementById('contractorIsInternal').checked = c.is_internal;
                    document.getElementById('contractorActive').checked = c.active;
                    document.getElementById('contractorNotes').value = c.notes || '';
                }
            } else {
                title.textContent = 'Add Contractor';
                document.getElementById('contractorForm').reset();
                document.getElementById('contractorVatRegistered').checked = true;
                document.getElementById('contractorActive').checked = true;
                document.getElementById('contractorPaymentTerms').value = 30;
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeContractorModal() {
            document.getElementById('contractorModal').classList.add('hidden');
            editingContractorId = null;
        }
        
        function editContractor(id) {
            openContractorModal(id);
        }
        
        async function saveContractor() {
            const data = {
                code: document.getElementById('contractorCode').value.toUpperCase(),
                name: document.getElementById('contractorName').value,
                address_line1: document.getElementById('contractorAddress1').value,
                address_line2: document.getElementById('contractorAddress2').value,
                city: document.getElementById('contractorCity').value,
                postcode: document.getElementById('contractorPostcode').value,
                contact_name: document.getElementById('contractorContactName').value,
                contact_email: document.getElementById('contractorContactEmail').value,
                contact_phone: document.getElementById('contractorContactPhone').value,
                po_email: document.getElementById('contractorPOEmail').value,
                vat_registered: document.getElementById('contractorVatRegistered').checked,
                vat_number: document.getElementById('contractorVatNumber').value,
                payment_terms: parseInt(document.getElementById('contractorPaymentTerms').value) || 30,
                is_internal: document.getElementById('contractorIsInternal').checked,
                active: document.getElementById('contractorActive').checked,
                notes: document.getElementById('contractorNotes').value
            };
            
            try {
                if (editingContractorId) {
                    await api(`/contractors/${editingContractorId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast('Contractor updated');
                } else {
                    await api('/contractors', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Contractor created');
                }
                closeContractorModal();
                loadContractors();
            } catch (err) {
                console.error('Save contractor error:', err);
                showToast('Failed to save contractor', 'error');
            }
        }
        
        // ============ LOCATIONS ============
        
        async function loadLocations() {
            try {
                locations = await api('/locations');
                renderLocations();
            } catch (err) {
                console.error('Load locations error:', err);
                showToast('Failed to load locations', 'error');
            }
        }
        
        function renderLocations() {
            const body = document.getElementById('locationsBody');
            if (!body) return;
            
            body.innerHTML = locations.map(l => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-sm">${l.code}</td>
                    <td class="px-3 py-2">${l.name}</td>
                    <td class="px-3 py-2 text-sm">${l.address_line1 || '-'}</td>
                    <td class="px-3 py-2 text-sm">${l.city || '-'}</td>
                    <td class="px-3 py-2 text-sm">${l.postcode || '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600">${l.location_type || 'depot'}</span></td>
                    <td class="px-3 py-2">
                        <button onclick="editLocation(${l.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openLocationModal(id = null) {
            editingLocationId = id;
            const modal = document.getElementById('locationModal');
            const title = document.getElementById('locationModalTitle');
            
            if (id) {
                title.textContent = 'Edit Location';
                const l = locations.find(x => x.id === id);
                if (l) {
                    document.getElementById('locationCode').value = l.code || '';
                    document.getElementById('locationName').value = l.name || '';
                    document.getElementById('locationAddress1').value = l.address_line1 || '';
                    document.getElementById('locationAddress2').value = l.address_line2 || '';
                    document.getElementById('locationCity').value = l.city || '';
                    document.getElementById('locationPostcode').value = l.postcode || '';
                    document.getElementById('locationType').value = l.location_type || 'depot';
                    document.getElementById('locationActive').checked = l.active;
                    document.getElementById('locationNotes').value = l.notes || '';
                }
            } else {
                title.textContent = 'Add Location';
                document.getElementById('locationForm').reset();
                document.getElementById('locationActive').checked = true;
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
            editingLocationId = null;
        }
        
        function editLocation(id) {
            openLocationModal(id);
        }
        
        async function saveLocation() {
            const data = {
                code: document.getElementById('locationCode').value.toUpperCase(),
                name: document.getElementById('locationName').value,
                address_line1: document.getElementById('locationAddress1').value,
                address_line2: document.getElementById('locationAddress2').value,
                city: document.getElementById('locationCity').value,
                postcode: document.getElementById('locationPostcode').value,
                location_type: document.getElementById('locationType').value,
                active: document.getElementById('locationActive').checked,
                notes: document.getElementById('locationNotes').value
            };
            
            try {
                if (editingLocationId) {
                    await api(`/locations/${editingLocationId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast('Location updated');
                } else {
                    await api('/locations', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Location created');
                }
                closeLocationModal();
                loadLocations();
            } catch (err) {
                console.error('Save location error:', err);
                showToast('Failed to save location', 'error');
            }
        }
        
        // ============ ROUTE COSTS ============
        
        async function loadRouteCostFilters() {
            try {
                const contractorCodes = await api('/schedule/contractor-codes');
                const routeRefs = await api('/schedule/route-refs');
                
                const contractorSelect = document.getElementById('filterRouteCostContractor');
                const routeSelect = document.getElementById('filterRouteCostRoute');
                
                if (contractorSelect) {
                    contractorSelect.innerHTML = '<option value="">All Contractors</option>' +
                        contractorCodes.map(c => `<option value="${c}">${c}</option>`).join('');
                }
                
                if (routeSelect) {
                    routeSelect.innerHTML = '<option value="">All Routes</option>' +
                        routeRefs.map(r => `<option value="${r}">${r}</option>`).join('');
                }
            } catch (err) {
                console.error('Load filters error:', err);
            }
        }
        
        async function loadRouteCosts() {
            try {
                const contractor = document.getElementById('filterRouteCostContractor')?.value || '';
                const route = document.getElementById('filterRouteCostRoute')?.value || '';
                
                let url = '/route-costs?active=true';
                if (contractor) url += `&contractor_code=${contractor}`;
                if (route) url += `&route_ref=${route}`;
                
                routeCosts = await api(url);
                renderRouteCosts();
            } catch (err) {
                console.error('Load route costs error:', err);
                showToast('Failed to load route costs', 'error');
            }
        }
        
        function renderRouteCosts() {
            const body = document.getElementById('routeCostsBody');
            if (!body) return;
            
            const dayTypeLabels = { weekday: 'Weekday', weekend: 'Weekend', bank_holiday: 'Bank Holiday' };
            
            body.innerHTML = routeCosts.map(rc => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-sm">${rc.route_ref}</td>
                    <td class="px-3 py-2">${rc.contractor_name || rc.contractor_code}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${rc.day_type === 'weekday' ? 'bg-slate-100' : rc.day_type === 'weekend' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${dayTypeLabels[rc.day_type] || rc.day_type}</span></td>
                    <td class="px-3 py-2 font-medium">¬£${parseFloat(rc.base_cost).toFixed(2)}</td>
                    <td class="px-3 py-2 text-sm">${rc.effective_from ? new Date(rc.effective_from).toLocaleDateString('en-GB') : '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${rc.active ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${rc.active ? 'Active' : 'Inactive'}</span></td>
                    <td class="px-3 py-2">
                        <button onclick="editRouteCost(${rc.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                        <button onclick="deleteRouteCost(${rc.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openRouteCostModal(id = null) {
            editingRouteCostId = id;
            const modal = document.getElementById('routeCostModal');
            const title = document.getElementById('routeCostModalTitle');
            
            // Populate dropdowns
            loadRouteCostModalDropdowns();
            
            if (id) {
                title.textContent = 'Edit Route Cost';
                const rc = routeCosts.find(x => x.id === id);
                if (rc) {
                    document.getElementById('routeCostRoute').value = rc.route_ref || '';
                    document.getElementById('routeCostContractor').value = rc.contractor_code || '';
                    document.getElementById('routeCostDayType').value = rc.day_type || 'weekday';
                    document.getElementById('routeCostBaseCost').value = rc.base_cost || '';
                    document.getElementById('routeCostEffectiveFrom').value = rc.effective_from ? rc.effective_from.split('T')[0] : '';
                    document.getElementById('routeCostEffectiveTo').value = rc.effective_to ? rc.effective_to.split('T')[0] : '';
                    document.getElementById('routeCostActive').checked = rc.active;
                    document.getElementById('routeCostNotes').value = rc.notes || '';
                }
            } else {
                title.textContent = 'Add Route Cost';
                document.getElementById('routeCostForm').reset();
                document.getElementById('routeCostActive').checked = true;
                document.getElementById('routeCostEffectiveFrom').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.remove('hidden');
        }
        
        async function loadRouteCostModalDropdowns() {
            try {
                const contractorCodes = await api('/schedule/contractor-codes');
                const routeRefs = await api('/schedule/route-refs');
                
                document.getElementById('routeCostContractor').innerHTML = 
                    '<option value="">Select Contractor</option>' +
                    contractorCodes.map(c => `<option value="${c}">${c}</option>`).join('');
                
                document.getElementById('routeCostRoute').innerHTML = 
                    '<option value="">Select Route</option>' +
                    routeRefs.map(r => `<option value="${r}">${r}</option>`).join('');
            } catch (err) {
                console.error('Load dropdowns error:', err);
            }
        }
        
        function closeRouteCostModal() {
            document.getElementById('routeCostModal').classList.add('hidden');
            editingRouteCostId = null;
        }
        
        function editRouteCost(id) {
            openRouteCostModal(id);
        }
        
        async function saveRouteCost() {
            const data = {
                route_ref: document.getElementById('routeCostRoute').value,
                contractor_code: document.getElementById('routeCostContractor').value,
                day_type: document.getElementById('routeCostDayType').value,
                base_cost: parseFloat(document.getElementById('routeCostBaseCost').value),
                effective_from: document.getElementById('routeCostEffectiveFrom').value || null,
                effective_to: document.getElementById('routeCostEffectiveTo').value || null,
                active: document.getElementById('routeCostActive').checked,
                notes: document.getElementById('routeCostNotes').value
            };
            
            if (!data.route_ref || !data.contractor_code || !data.base_cost) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                if (editingRouteCostId) {
                    await api(`/route-costs/${editingRouteCostId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast('Route cost updated');
                } else {
                    await api('/route-costs', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Route cost created');
                }
                closeRouteCostModal();
                loadRouteCosts();
            } catch (err) {
                console.error('Save route cost error:', err);
                showToast('Failed to save route cost', 'error');
            }
        }
        
        async function deleteRouteCost(id) {
            if (!confirm('Are you sure you want to delete this route cost?')) return;
            
            try {
                await api(`/route-costs/${id}`, { method: 'DELETE' });
                showToast('Route cost deleted');
                loadRouteCosts();
            } catch (err) {
                console.error('Delete route cost error:', err);
                showToast('Failed to delete route cost', 'error');
            }
        }
        
        // ============ BANK HOLIDAYS ============
        
        async function loadBankHolidays() {
            try {
                const year = new Date().getFullYear();
                bankHolidays = await api(`/bank-holidays?year=${year}`);
                renderBankHolidays();
            } catch (err) {
                console.error('Load bank holidays error:', err);
                showToast('Failed to load bank holidays', 'error');
            }
        }
        
        function renderBankHolidays() {
            const grid = document.getElementById('bankHolidaysGrid');
            if (!grid) return;
            
            if (bankHolidays.length === 0) {
                grid.innerHTML = '<p class="text-slate-500 col-span-3">No bank holidays defined for this year.</p>';
                return;
            }
            
            grid.innerHTML = bankHolidays.map(bh => `
                <div class="bg-white border border-slate-200 rounded-lg p-3 flex items-center justify-between">
                    <div>
                        <p class="font-medium text-slate-800">${new Date(bh.holiday_date).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</p>
                        <p class="text-sm text-slate-500">${bh.description || 'Bank Holiday'}</p>
                    </div>
                    <button onclick="deleteBankHoliday(${bh.id})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            
            lucide.createIcons();
        }
        
        function openBankHolidayModal() {
            document.getElementById('bankHolidayForm').reset();
            document.getElementById('bankHolidayModal').classList.remove('hidden');
        }
        
        function closeBankHolidayModal() {
            document.getElementById('bankHolidayModal').classList.add('hidden');
        }
        
        async function saveBankHoliday() {
            const data = {
                holiday_date: document.getElementById('bankHolidayDate').value,
                description: document.getElementById('bankHolidayDescription').value
            };
            
            if (!data.holiday_date) {
                showToast('Please select a date', 'error');
                return;
            }
            
            try {
                await api('/bank-holidays', { method: 'POST', body: JSON.stringify(data) });
                showToast('Bank holiday added');
                closeBankHolidayModal();
                loadBankHolidays();
            } catch (err) {
                console.error('Save bank holiday error:', err);
                showToast('Failed to save bank holiday', 'error');
            }
        }
        
        async function deleteBankHoliday(id) {
            if (!confirm('Are you sure you want to delete this bank holiday?')) return;
            
            try {
                await api(`/bank-holidays/${id}`, { method: 'DELETE' });
                showToast('Bank holiday deleted');
                loadBankHolidays();
            } catch (err) {
                console.error('Delete bank holiday error:', err);
                showToast('Failed to delete bank holiday', 'error');
            }
        }
        
        // ============ COMPANY SETTINGS ============
        
        async function loadCompanySettings() {
            try {
                companySettings = await api('/company-settings');
                
                document.getElementById('settingCompanyName').value = companySettings.company_name || '';
                document.getElementById('settingCompanyAddress1').value = companySettings.company_address_line1 || '';
                document.getElementById('settingCompanyAddress2').value = companySettings.company_address_line2 || '';
                document.getElementById('settingCompanyCity').value = companySettings.company_city || '';
                document.getElementById('settingCompanyPostcode').value = companySettings.company_postcode || '';
                document.getElementById('settingInvoiceAddress1').value = companySettings.invoice_address_line1 || '';
                document.getElementById('settingInvoiceAddress2').value = companySettings.invoice_address_line2 || '';
                document.getElementById('settingInvoiceCity').value = companySettings.invoice_city || '';
                document.getElementById('settingInvoicePostcode').value = companySettings.invoice_postcode || '';
                document.getElementById('settingQueryContactName').value = companySettings.query_contact_name || '';
                document.getElementById('settingQueryContactEmail').value = companySettings.query_contact_email || '';
                document.getElementById('settingQueryContactPhone').value = companySettings.query_contact_phone || '';
                document.getElementById('settingVatRate').value = companySettings.vat_rate || 20;
                document.getElementById('settingFscPercent').value = companySettings.fuel_surcharge_percent || 15;
                document.getElementById('settingPaymentDays').value = companySettings.payment_terms_days || 30;
                document.getElementById('settingPaymentText').value = companySettings.payment_terms_text || '';
            } catch (err) {
                console.error('Load company settings error:', err);
                showToast('Failed to load company settings', 'error');
            }
        }
        
        async function saveCompanySettings() {
            const data = {
                company_name: document.getElementById('settingCompanyName').value,
                company_address_line1: document.getElementById('settingCompanyAddress1').value,
                company_address_line2: document.getElementById('settingCompanyAddress2').value,
                company_city: document.getElementById('settingCompanyCity').value,
                company_postcode: document.getElementById('settingCompanyPostcode').value,
                invoice_address_line1: document.getElementById('settingInvoiceAddress1').value,
                invoice_address_line2: document.getElementById('settingInvoiceAddress2').value,
                invoice_city: document.getElementById('settingInvoiceCity').value,
                invoice_postcode: document.getElementById('settingInvoicePostcode').value,
                query_contact_name: document.getElementById('settingQueryContactName').value,
                query_contact_email: document.getElementById('settingQueryContactEmail').value,
                query_contact_phone: document.getElementById('settingQueryContactPhone').value,
                vat_rate: document.getElementById('settingVatRate').value,
                fuel_surcharge_percent: document.getElementById('settingFscPercent').value,
                payment_terms_days: document.getElementById('settingPaymentDays').value,
                payment_terms_text: document.getElementById('settingPaymentText').value
            };
            
            try {
                await api('/company-settings', { method: 'PUT', body: JSON.stringify(data) });
                showToast('Company settings saved');
            } catch (err) {
                console.error('Save company settings error:', err);
                showToast('Failed to save settings', 'error');
            }
        }
        
        // ============ PURCHASE ORDERS ============
        
        async function loadPOFilters() {
            try {
                const contractorsList = await api('/contractors?active=true');
                const select = document.getElementById('filterPOContractor');
                if (select) {
                    select.innerHTML = '<option value="">All Contractors</option>' +
                        contractorsList.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (err) {
                console.error('Load PO filters error:', err);
            }
        }
        
        async function loadPurchaseOrders() {
            try {
                const status = document.getElementById('filterPOStatus')?.value || '';
                const contractor = document.getElementById('filterPOContractor')?.value || '';
                
                let url = '/purchase-orders?';
                if (status) url += `status=${status}&`;
                if (contractor) url += `contractor_id=${contractor}&`;
                
                purchaseOrders = await api(url);
                renderPurchaseOrders();
            } catch (err) {
                console.error('Load purchase orders error:', err);
                showToast('Failed to load purchase orders', 'error');
            }
        }
        
        function renderPurchaseOrders() {
            const body = document.getElementById('purchaseOrdersBody');
            if (!body) return;
            
            const statusColors = {
                draft: 'bg-slate-100 text-slate-600',
                authorised: 'bg-amber-100 text-amber-700',
                sent: 'bg-emerald-100 text-emerald-700'
            };
            
            body.innerHTML = purchaseOrders.map(po => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-sm font-medium">${po.po_number}</td>
                    <td class="px-3 py-2">${po.contractor_name}</td>
                    <td class="px-3 py-2 text-sm">${new Date(po.week_commencing).toLocaleDateString('en-GB')} - ${new Date(po.week_ending).toLocaleDateString('en-GB')}</td>
                    <td class="px-3 py-2 font-medium">¬£${parseFloat(po.grand_total).toFixed(2)}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${statusColors[po.status] || 'bg-slate-100'}">${po.status}</span></td>
                    <td class="px-3 py-2 text-sm">${new Date(po.created_at).toLocaleDateString('en-GB')}</td>
                    <td class="px-3 py-2">
                        <button onclick="viewPurchaseOrder(${po.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">View</button>
                        ${po.status === 'draft' && getPermissions().canAuthorisePO ? `<button onclick="authorisePO(${po.id})" class="text-emerald-600 hover:text-emerald-800 text-sm mr-2">Authorise</button>` : ''}
                        ${po.status === 'authorised' ? `<button onclick="markPOSent(${po.id})" class="text-amber-600 hover:text-amber-800 text-sm">Mark Sent</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function openCreatePOModal() {
            document.getElementById('createPOModal').classList.remove('hidden');
            loadCreatePOContractors();
        }
        
        function closeCreatePOModal() {
            document.getElementById('createPOModal').classList.add('hidden');
            document.getElementById('poPreview').classList.add('hidden');
        }
        
        async function loadCreatePOContractors() {
            try {
                const contractorsList = await api('/contractors?active=true');
                const select = document.getElementById('poContractor');
                select.innerHTML = '<option value="">Select Contractor</option>' +
                    contractorsList.map(c => `<option value="${c.id}">${c.name} (${c.code})</option>`).join('');
            } catch (err) {
                console.error('Load contractors error:', err);
            }
        }
        
        async function previewPO() {
            const contractor_id = document.getElementById('poContractor').value;
            const week_commencing = document.getElementById('poWeekCommencing').value;
            
            if (!contractor_id || !week_commencing) {
                showToast('Please select contractor and week', 'error');
                return;
            }
            
            try {
                const preview = await api('/purchase-orders/preview', {
                    method: 'POST',
                    body: JSON.stringify({ contractor_id, week_commencing })
                });
                
                window.currentPOPreview = preview;
                
                document.getElementById('poPreviewContractor').textContent = preview.contractor.name;
                document.getElementById('poPreviewWeek').textContent = `${new Date(preview.week_commencing).toLocaleDateString('en-GB')} - ${new Date(preview.week_ending).toLocaleDateString('en-GB')}`;
                document.getElementById('poPreviewSubtotal').textContent = `¬£${preview.subtotal}`;
                document.getElementById('poPreviewFSC').textContent = `¬£${preview.fsc_total} (${preview.fsc_percent}%)`;
                document.getElementById('poPreviewVAT').textContent = `¬£${preview.vat_amount} (${preview.vat_rate}%)`;
                document.getElementById('poPreviewTotal').textContent = `¬£${preview.grand_total}`;
                document.getElementById('poPreviewLineCount').textContent = `${preview.lines.length} route(s)`;
                
                document.getElementById('poPreview').classList.remove('hidden');
            } catch (err) {
                console.error('Preview PO error:', err);
                showToast('Failed to preview PO', 'error');
            }
        }
        
        async function createPO() {
            if (!window.currentPOPreview) {
                showToast('Please preview PO first', 'error');
                return;
            }
            
            const preview = window.currentPOPreview;
            
            try {
                const result = await api('/purchase-orders', {
                    method: 'POST',
                    body: JSON.stringify({
                        contractor_id: preview.contractor.id,
                        week_commencing: preview.week_commencing,
                        lines: preview.lines,
                        subtotal: preview.subtotal,
                        fsc_total: preview.fsc_total,
                        vat_amount: preview.vat_amount,
                        grand_total: preview.grand_total,
                        notes: document.getElementById('poNotes').value
                    })
                });
                
                showToast(`PO ${result.po_number} created`);
                closeCreatePOModal();
                loadPurchaseOrders();
            } catch (err) {
                console.error('Create PO error:', err);
                showToast('Failed to create PO', 'error');
            }
        }
        
        async function viewPurchaseOrder(id) {
            // TODO: Implement PO view/print modal
            showToast('PO view coming soon');
        }
        
        async function authorisePO(id) {
            if (!confirm('Are you sure you want to authorise this PO?')) return;
            
            try {
                await api(`/purchase-orders/${id}/authorise`, { method: 'PUT' });
                showToast('PO authorised');
                loadPurchaseOrders();
            } catch (err) {
                console.error('Authorise PO error:', err);
                showToast('Failed to authorise PO', 'error');
            }
        }
        
        async function markPOSent(id) {
            const email = prompt('Enter email address PO was sent to:');
            if (!email) return;
            
            try {
                await api(`/purchase-orders/${id}/sent`, {
                    method: 'PUT',
                    body: JSON.stringify({ sent_to: email })
                });
                showToast('PO marked as sent');
                loadPurchaseOrders();
            } catch (err) {
                console.error('Mark PO sent error:', err);
                showToast('Failed to update PO', 'error');
            }
        }
        
        // ============ CREDIT NOTES ============
        
        async function loadCreditNotes() {
            try {
                creditNotes = await api('/credit-notes');
                renderCreditNotes();
            } catch (err) {
                console.error('Load credit notes error:', err);
                showToast('Failed to load credit notes', 'error');
            }
        }
        
        function renderCreditNotes() {
            const body = document.getElementById('creditNotesBody');
            if (!body) return;
            
            if (creditNotes.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-center text-slate-500">No credit notes found</td></tr>';
                return;
            }
            
            const statusColors = {
                draft: 'bg-slate-100 text-slate-600',
                authorised: 'bg-amber-100 text-amber-700',
                sent: 'bg-emerald-100 text-emerald-700'
            };
            
            body.innerHTML = creditNotes.map(cn => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-sm font-medium">${cn.credit_number}</td>
                    <td class="px-3 py-2 font-mono text-sm">${cn.po_number}</td>
                    <td class="px-3 py-2">${cn.contractor_name}</td>
                    <td class="px-3 py-2 font-medium text-red-600">-¬£${parseFloat(cn.grand_total).toFixed(2)}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${statusColors[cn.status] || 'bg-slate-100'}">${cn.status}</span></td>
                    <td class="px-3 py-2 text-sm">${new Date(cn.created_at).toLocaleDateString('en-GB')}</td>
                    <td class="px-3 py-2">
                        <button onclick="viewCreditNote(${cn.id})" class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function viewCreditNote(id) {
            showToast('Credit note view coming soon');
        }
        
        // ============ REPORTS ============
        
        function initCostingReportDates() {
            const today = new Date();
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - today.getDay() - 6);
            const lastSunday = new Date(lastMonday);
            lastSunday.setDate(lastMonday.getDate() + 6);
            
            document.getElementById('reportFromDate').value = lastMonday.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = lastSunday.toISOString().split('T')[0];
        }
        
        async function exportCostReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/reports/weekly-export?from_date=${fromDate}&to_date=${toDate}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `TMS_Cost_Report_${fromDate}_to_${toDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showToast('Report downloaded');
            } catch (err) {
                console.error('Export error:', err);
                showToast('Failed to export report', 'error');
            }
        }
    </script>
</body>
</html>
